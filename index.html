<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resebudget Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #2C5F2D;
            --primary-light: #97BC62;
            --accent: #FF6B35;
            --bg: #FFFEF2;
            --card: #FFFFFF;
            --text: #1A1A1A;
            --text-muted: #666666;
            --border: #E0E0E0;
            --success: #4CAF50;
            --warning: #FFA726;
            --error: #EF5350;
        }

        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .app-container { min-height: 100vh; padding: 2rem; }

        .header {
            max-width: 1400px; margin: 0 auto 2rem;
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 1.5rem; border-bottom: 2px solid var(--primary);
        }
        .logo { font-family: 'Space Mono', monospace; font-size: 1.8rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-badge {
            background: var(--primary); color: white; padding: 0.5rem 1rem;
            border-radius: 20px; font-size: 0.9rem; font-weight: 500;
            cursor: default;
        }
        .user-badge.admin-badge {
            background: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .user-badge.admin-badge:hover {
            background: #e55a2b;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255,107,53,0.35);
        }

        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: #3a7a3b; transform: translateY(-2px); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover:not(:disabled) { background: var(--primary); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-danger:hover:not(:disabled) { background: #c62828; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-icon { padding: 0.35rem 0.6rem; font-size: 0.9rem; border-radius: 6px; line-height: 1; }

        .main-content { max-width: 1400px; margin: 0 auto; }

        .login-container { max-width: 400px; margin: 5rem auto; background: var(--card); padding: 3rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .login-title { font-family: 'Space Mono', monospace; font-size: 2rem; margin-bottom: 2rem; text-align: center; color: var(--primary); }

        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); }
        .form-input { width: 100%; padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 1rem; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-select { width: 100%; padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 1rem; background: white; cursor: pointer; }

        /* TABS */
        .tabs {
            display: flex; gap: 0; margin-bottom: 2rem;
            background: white; border-radius: 12px; padding: 0.4rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07); border: 1px solid var(--border);
            width: fit-content;
        }
        .tab {
            padding: 0.75rem 1.75rem; background: none; border: none;
            font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 500;
            color: var(--text-muted); cursor: pointer; border-radius: 8px;
            transition: all 0.2s; position: relative; white-space: nowrap;
        }
        .tab.active {
            background: var(--primary); color: white;
            box-shadow: 0 2px 8px rgba(44,95,45,0.3);
        }
        .tab:not(.active):hover { color: var(--primary); background: #f0f7f0; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--card); padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .card-title { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .stat-card { text-align: center; padding: 2rem; }
        .stat-value { font-family: 'Space Mono', monospace; font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-muted); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }

        /* TRIP CARDS */
        .trip-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }
        .trip-card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .trip-card:hover {
            border-color: var(--primary-light);
            box-shadow: 0 4px 16px rgba(44,95,45,0.12);
            transform: translateY(-2px);
        }
        .trip-card.selected {
            border-color: var(--primary);
            background: #f0f7f0;
            box-shadow: 0 4px 16px rgba(44,95,45,0.18);
        }
        .trip-card-icon { font-size: 2rem; margin-bottom: 0.25rem; }
        .trip-card-name { font-weight: 700; font-size: 1.05rem; color: var(--text); line-height: 1.3; }
        .trip-card-meta { font-size: 0.8rem; color: var(--text-muted); }
        .trip-card-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--border);
        }
        .trip-card-total { font-family: 'Space Mono', monospace; font-size: 0.95rem; font-weight: 700; color: var(--primary); }
        .trip-card-del {
            background: none; border: none; cursor: pointer;
            color: var(--text-muted); font-size: 1rem; padding: 0.25rem;
            border-radius: 6px; transition: all 0.15s; line-height: 1;
        }
        .trip-card-del:hover { color: var(--error); background: #ffebee; }
        .trip-card-new {
            border: 2px dashed var(--border);
            background: transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 0.5rem; color: var(--text-muted); min-height: 130px;
            font-size: 0.95rem; font-weight: 500;
        }
        .trip-card-new:hover {
            border-color: var(--primary-light); color: var(--primary);
            background: #f9fff9; transform: translateY(-2px);
        }
        .trip-card-new .plus-icon { font-size: 1.8rem; color: var(--primary-light); }

        /* EXPENSE LIST */
        .expense-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .expense-item { background: var(--card); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); display: grid; grid-template-columns: auto 1fr auto auto; gap: 1rem; align-items: center; transition: background 0.15s; }
        .expense-item:hover { background: #fafafa; }
        .expense-category { width: 46px; height: 46px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; background: var(--bg); flex-shrink: 0; }
        .expense-details { min-width: 0; }
        .expense-description { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .expense-meta { font-size: 0.875rem; color: var(--text-muted); }
        .expense-amount { text-align: right; white-space: nowrap; }
        .expense-price { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; }
        .expense-currency { font-size: 0.75rem; color: var(--text-muted); }

        .quick-add-form { background: var(--primary); padding: 1.5rem; border-radius: 12px; color: white; margin-bottom: 2rem; }
        .quick-add-form .form-input, .quick-add-form .form-select { background: rgba(255,255,255,0.95); }
        .quick-add-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end; }

        /* CATEGORY MANAGER */
        .cat-section { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .cat-section-title { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .cat-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .cat-chip { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.65rem; border-radius: 20px; font-size: 0.85rem; background: white; border: 1px solid var(--border); }
        .cat-chip-del { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; line-height: 1; padding: 0 0 0 0.1rem; transition: color 0.15s; }
        .cat-chip-del:hover { color: var(--error); }
        .cat-add-row { display: flex; gap: 0.5rem; align-items: center; }
        .cat-add-row input { flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; font-family: 'DM Sans', sans-serif; }
        .cat-add-row input:focus { outline: none; border-color: var(--primary); }
        .emoji-picker { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.6rem; }
        .emoji-btn { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 0.2rem 0.4rem; font-size: 1.1rem; cursor: pointer; transition: all 0.15s; }
        .emoji-btn:hover { border-color: var(--primary); }
        .emoji-btn.active { background: var(--primary); border-color: var(--primary); }

        /* DAY BREAKDOWN */
        .day-breakdown { margin-top: 2rem; }
        .day-group { margin-bottom: 1.25rem; }
        .day-group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 1rem; background: var(--primary); color: white;
            border-radius: 8px 8px 0 0; font-weight: 600; font-size: 0.95rem;
        }
        .day-group-total { font-family: 'Space Mono', monospace; font-size: 0.9rem; }
        .day-group-items { border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; overflow: hidden; }
        .day-group-items .expense-item { border-radius: 0; border: none; border-bottom: 1px solid var(--border); }
        .day-group-items .expense-item:last-child { border-bottom: none; }

        /* CONFIRM MODAL */
        .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 200; padding: 1rem; }
        .confirm-box { background: white; border-radius: 12px; padding: 2rem; max-width: 360px; width: 100%; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        .confirm-box h3 { font-size: 1.2rem; margin-bottom: 0.5rem; }
        .confirm-box p { color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.5; }
        .confirm-btns { display: flex; gap: 0.75rem; }
        .confirm-btns .btn { flex: 1; justify-content: center; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 2rem; }
        .modal { background: var(--card); padding: 2rem; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .close-btn:hover { background: var(--border); color: var(--text); }

        .user-list { display: flex; flex-direction: column; gap: 1rem; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg); border-radius: 8px; }
        .user-item-info { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; }

        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .alert-success { background: #E8F5E9; color: #2E7D32; border: 1px solid #4CAF50; }
        .alert-error { background: #FFEBEE; color: #C62828; border: 1px solid #EF5350; }
        .loading { text-align: center; padding: 3rem; color: var(--text-muted); }
        .spinner { border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* PLACEHOLDER */
        .placeholder-box {
            text-align: center; padding: 5rem 2rem;
            background: var(--card); border-radius: 16px;
            border: 2px dashed var(--border);
        }
        .placeholder-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.4; }
        .placeholder-title { font-size: 1.4rem; font-weight: 700; color: var(--text-muted); margin-bottom: 0.5rem; }
        .placeholder-desc { color: var(--text-muted); font-size: 0.95rem; max-width: 350px; margin: 0 auto; }

        /* NEW TRIP MODAL */
        .new-trip-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 150; padding: 1rem; }
        .new-trip-box { background: white; border-radius: 14px; padding: 2rem; max-width: 420px; width: 100%; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        .new-trip-box h3 { font-size: 1.3rem; font-weight: 700; color: var(--primary); margin-bottom: 1.25rem; }

        /* VIEW TOGGLE */
        .view-toggle { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; }
        .view-toggle-label { font-size: 0.85rem; color: var(--text-muted); margin-right: 0.25rem; }
        .toggle-btn { padding: 0.4rem 0.9rem; border-radius: 20px; border: 1.5px solid var(--border); background: white; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; color: var(--text-muted); transition: all 0.15s; }
        .toggle-btn.active { background: var(--primary); border-color: var(--primary); color: white; font-weight: 600; }

        /* BUDGET BAR */
        .budget-bar-wrap { margin-top: 0.5rem; }
        .budget-bar-track { height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; }
        .budget-bar-fill { height: 100%; border-radius: 99px; transition: width 0.4s, background 0.4s; }
        .budget-bar-fill.ok { background: var(--success); }
        .budget-bar-fill.warning { background: var(--warning); }
        .budget-bar-fill.danger { background: var(--error); }
        .budget-bar-fill.over { background: var(--error); width: 100% !important; }
        .budget-labels { display: flex; justify-content: space-between; font-size: 0.72rem; margin-top: 0.3rem; color: var(--text-muted); font-family: 'Space Mono', monospace; }
        .budget-remaining { font-weight: 700; }
        .budget-remaining.danger { color: var(--error); }

        /* COMPLETED TRIP CARD */
        .trip-card.completed {
            opacity: 0.85;
            background: #fafafa;
        }
        .trip-card.completed .trip-card-name { color: var(--text-muted); }
        .completed-badge {
            display: inline-block; font-size: 0.7rem; font-weight: 700;
            background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7;
            border-radius: 20px; padding: 0.1rem 0.5rem; margin-top: 0.2rem;
            letter-spacing: 0.03em;
        }

        /* AVSLUTADE RESOR VIEW */
        .completed-trip-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 1.5rem;
            display: flex; flex-direction: column; gap: 0.75rem;
        }
        .completed-trip-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .completed-trip-name { font-weight: 700; font-size: 1.1rem; }
        .completed-trip-stats { display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.875rem; color: var(--text-muted); }
        .completed-trip-stat-val { font-family: 'Space Mono', monospace; font-weight: 700; color: var(--text); font-size: 1rem; }

        @media (max-width: 768px) {
            .quick-add-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 1rem; text-align: center; }
            .expense-item { grid-template-columns: auto 1fr auto; }
            .trip-cards-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const SUPABASE_URL = 'https://sxgrwpqdocluntpuotib.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4Z3J3cHFkb2NsdW50cHVvdGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwOTA5NDksImV4cCI6MjA4NjY2Njk0OX0.r9GqncCA9iH8iqhzV4YB8b-WYMd-mf2z_e8aZ8e951k';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const DEFAULT_CATEGORIES = [
    { id: 'food', name: 'Mat & Restaurang', icon: 'ğŸ½ï¸' },
    { id: 'transport', name: 'Transport', icon: 'ğŸš—' },
    { id: 'accommodation', name: 'Boende', icon: 'ğŸ¨' },
    { id: 'activities', name: 'Aktiviteter', icon: 'ğŸ­' },
    { id: 'shopping', name: 'Shopping', icon: 'ğŸ›ï¸' },
    { id: 'other', name: 'Ã–vrigt', icon: 'ğŸ“Œ' }
];

const EMOJI_OPTIONS = ['ğŸ½ï¸','ğŸš—','ğŸ¨','ğŸ­','ğŸ›ï¸','ğŸ“Œ','â˜•','ğŸº','ğŸµ','âš½','ğŸ–ï¸','ğŸ¡','ğŸ’Š','ğŸ“¸','ğŸš¢','âœˆï¸','ğŸš‚','ğŸ”ï¸','ğŸ°','ğŸ¾','ğŸ›º','ğŸ¤¿','ğŸª','ğŸ›’'];

const CURRENCIES = [
    { code: 'SEK', symbol: 'kr', rate: 1 },
    { code: 'EUR', symbol: 'â‚¬', rate: 11.5 },
    { code: 'USD', symbol: '$', rate: 10.8 },
    { code: 'GBP', symbol: 'Â£', rate: 13.5 },
    { code: 'NOK', symbol: 'kr', rate: 1.0 },
    { code: 'DKK', symbol: 'kr', rate: 1.54 },
    { code: 'THB', symbol: 'à¸¿', rate: 0.31 },
    { code: 'JPY', symbol: 'Â¥', rate: 0.073 }
];

// â”€â”€ BEKRÃ„FTELSEDIALOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ConfirmDialog({ title, message, confirmLabel = 'Ta bort', onConfirm, onCancel }) {
    return (
        <div className="confirm-overlay" onClick={onCancel}>
            <div className="confirm-box" onClick={e => e.stopPropagation()}>
                <h3>{title}</h3>
                <p>{message}</p>
                <div className="confirm-btns">
                    <button className="btn btn-secondary" onClick={onCancel}>Avbryt</button>
                    <button className="btn btn-danger" onClick={onConfirm}>{confirmLabel}</button>
                </div>
            </div>
        </div>
    );
}

// â”€â”€ KATEGORIHANTERARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CategoryManager({ categories, onAdd, onDelete }) {
    const [newName, setNewName] = useState('');
    const [newEmoji, setNewEmoji] = useState('ğŸ“Œ');

    const handleAdd = () => {
        const name = newName.trim();
        if (!name) return;
        onAdd({ id: 'custom_' + Date.now(), name, icon: newEmoji });
        setNewName('');
        setNewEmoji('ğŸ“Œ');
    };

    return (
        <div className="cat-section">
            <div className="cat-section-title">
                <span>Kategorier</span>
            </div>
            <div className="cat-chips">
                {categories.map(cat => (
                    <span key={cat.id} className="cat-chip">
                        {cat.icon} {cat.name}
                        <button
                            className="cat-chip-del"
                            onClick={() => onDelete(cat.id)}
                            title="Ta bort kategori"
                        >Ã—</button>
                    </span>
                ))}
            </div>
            <div style={{fontSize:'0.78rem', color:'var(--text-muted)', marginBottom:'0.5rem'}}>LÃ¤gg till ny kategori:</div>
            <div className="emoji-picker">
                {EMOJI_OPTIONS.map(e => (
                    <button key={e} className={`emoji-btn ${newEmoji === e ? 'active' : ''}`} onClick={() => setNewEmoji(e)}>{e}</button>
                ))}
            </div>
            <div className="cat-add-row">
                <span style={{fontSize:'1.2rem'}}>{newEmoji}</span>
                <input
                    placeholder="Kategorinamn..."
                    value={newName}
                    onChange={e => setNewName(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && handleAdd()}
                />
                <button className="btn btn-primary btn-small" onClick={handleAdd} disabled={!newName.trim()}>
                    + LÃ¤gg till
                </button>
            </div>
        </div>
    );
}

// â”€â”€ BUDGETBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BudgetBar({ budget, spent }) {
    if (!budget || budget <= 0) return null;
    const remaining = budget - spent;
    const pct = Math.min((spent / budget) * 100, 100);
    const remainingPct = remaining / budget; // can be negative
    const isOver = spent > budget;
    const isDanger = !isOver && remainingPct <= 0.25;
    const isWarning = !isOver && !isDanger && remainingPct <= 0.5;
    const fillClass = isOver ? 'over' : isDanger ? 'danger' : isWarning ? 'warning' : 'ok';

    return (
        <div className="budget-bar-wrap">
            <div className="budget-bar-track">
                <div className="budget-bar-fill" style={{width: isOver ? '100%' : `${pct}%`}} className={`budget-bar-fill ${fillClass}`}></div>
            </div>
            <div className="budget-labels">
                <span>{isOver ? 'âš ï¸ Ã–verskriden' : `${((1 - pct/100) * 100).toFixed(0)}% kvar`}</span>
                <span className={`budget-remaining ${isDanger || isOver ? 'danger' : ''}`}>
                    {isOver ? `-${Math.abs(remaining).toFixed(0)} kr` : `${remaining.toFixed(0)} kr kvar`}
                </span>
            </div>
        </div>
    );
}

// â”€â”€ RESAKORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TripCards({ trips, selectedTrip, onSelectTrip, allExpenses, onAddTrip, onDeleteTrip, onCompleteTrip }) {
    const [showNewTrip, setShowNewTrip] = useState(false);
    const [newTripName, setNewTripName] = useState('');
    const [newTripBudget, setNewTripBudget] = useState('');

    const handleAddTrip = async (e) => {
        e.preventDefault();
        if (!newTripName.trim()) return;
        await onAddTrip({
            name: newTripName.trim(),
            budget: newTripBudget ? parseFloat(newTripBudget) : null,
            is_completed: false,
            created_at: new Date().toISOString()
        });
        setNewTripName('');
        setNewTripBudget('');
        setShowNewTrip(false);
    };

    const getTripTotal = (tripId) => {
        return allExpenses
            .filter(e => e.trip_id === tripId)
            .reduce((sum, e) => sum + e.amount * e.exchange_rate, 0);
    };

    const getTripIcons = ['âœˆï¸','ğŸŒ','ğŸï¸','ğŸ—ºï¸','ğŸš€','â›µ','ğŸ”ï¸','ğŸ’'];
    const getTripIcon = (tripId) => {
        const idx = parseInt(String(tripId).replace(/\D/g, '').slice(-1)) % getTripIcons.length;
        return getTripIcons[idx] || 'âœˆï¸';
    };

    // Only show active (non-completed) trips
    const activeTrips = trips.filter(t => !t.is_completed);

    return (
        <div>
            <div className="trip-cards-grid">
                {activeTrips.map(trip => {
                    const count = allExpenses.filter(e => e.trip_id === trip.id).length;
                    const total = getTripTotal(trip.id);
                    const hasBudget = trip.budget && trip.budget > 0;
                    return (
                        <div
                            key={trip.id}
                            className={`trip-card ${selectedTrip === trip.id ? 'selected' : ''}`}
                            onClick={() => onSelectTrip(selectedTrip === trip.id ? null : trip.id)}
                        >
                            <div className="trip-card-icon">{getTripIcon(trip.id)}</div>
                            <div className="trip-card-name">{trip.name}</div>
                            <div className="trip-card-meta">{count} {count === 1 ? 'utgift' : 'utgifter'}{hasBudget ? ` Â· Budget: ${trip.budget.toFixed(0)} kr` : ''}</div>
                            {hasBudget && <BudgetBar budget={trip.budget} spent={total} />}
                            <div className="trip-card-footer">
                                <span className="trip-card-total">{total > 0 ? `${total.toFixed(0)} kr` : 'â€“'}</span>
                                <div style={{display:'flex', gap:'0.3rem'}}>
                                    <button
                                        className="trip-card-del"
                                        title="Avsluta resa"
                                        style={{fontSize:'1rem'}}
                                        onClick={e => { e.stopPropagation(); onCompleteTrip(trip.id, trip.name); }}
                                    >âœ…</button>
                                    <button
                                        className="trip-card-del"
                                        title="Ta bort resa"
                                        onClick={e => { e.stopPropagation(); onDeleteTrip(trip.id, trip.name); }}
                                    >ğŸ—‘</button>
                                </div>
                            </div>
                        </div>
                    );
                })}

                {/* Ny resa-kort */}
                <div className="trip-card trip-card-new" onClick={() => setShowNewTrip(true)}>
                    <span className="plus-icon">+</span>
                    <span>Ny resa</span>
                </div>
            </div>

            {showNewTrip && (
                <div className="new-trip-overlay" onClick={() => setShowNewTrip(false)}>
                    <div className="new-trip-box" onClick={e => e.stopPropagation()}>
                        <h3>âœˆï¸ Skapa ny resa</h3>
                        <form onSubmit={handleAddTrip}>
                            <div className="form-group">
                                <label className="form-label">Resans namn</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="t.ex. Thailand 2026"
                                    value={newTripName}
                                    onChange={e => setNewTripName(e.target.value)}
                                    autoFocus
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Budget (kr) <span style={{fontWeight:400, color:'var(--text-muted)'}}>â€” valfritt</span></label>
                                <input
                                    type="number"
                                    min="0"
                                    step="1"
                                    className="form-input"
                                    placeholder="t.ex. 20000"
                                    value={newTripBudget}
                                    onChange={e => setNewTripBudget(e.target.value)}
                                />
                            </div>
                            <div style={{display:'flex', gap:'0.75rem'}}>
                                <button type="button" className="btn btn-secondary" style={{flex:1}} onClick={() => setShowNewTrip(false)}>Avbryt</button>
                                <button type="submit" className="btn btn-primary" style={{flex:1}} disabled={!newTripName.trim()}>Skapa resa</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}

// â”€â”€ DAGÃ–VERSIKT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DayBreakdown({ expenses, categories, users }) {
    const getCatInfo = (id) => categories.find(c => c.id === id) || { icon: 'ğŸ“Œ', name: id };
    const getUserName = (uid) => users.find(u => u.id === uid)?.name || 'OkÃ¤nd';

    const grouped = expenses.reduce((acc, e) => {
        const day = new Date(e.date).toLocaleDateString('sv-SE');
        if (!acc[day]) acc[day] = [];
        acc[day].push(e);
        return acc;
    }, {});

    const sortedDays = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

    if (sortedDays.length === 0) {
        return <p style={{textAlign:'center', color:'var(--text-muted)', padding:'2rem'}}>Inga utgifter att visa</p>;
    }

    return (
        <div className="day-breakdown">
            {sortedDays.map(day => {
                const dayExpenses = grouped[day];
                const dayTotal = dayExpenses.reduce((s, e) => s + e.amount * e.exchange_rate, 0);
                return (
                    <div key={day} className="day-group">
                        <div className="day-group-header">
                            <span>{day}</span>
                            <span className="day-group-total">{dayTotal.toFixed(0)} kr</span>
                        </div>
                        <div className="day-group-items">
                            {dayExpenses.map(expense => {
                                const cat = getCatInfo(expense.category);
                                return (
                                    <div key={expense.id} className="expense-item">
                                        <div className="expense-category">{cat.icon}</div>
                                        <div className="expense-details">
                                            <div className="expense-description">{expense.description}</div>
                                            <div className="expense-meta">
                                                {cat.name} Â· {getUserName(expense.added_by)}
                                            </div>
                                        </div>
                                        <div className="expense-amount">
                                            <div className="expense-price">{(expense.amount * expense.exchange_rate).toFixed(0)} kr</div>
                                            <div className="expense-currency">({expense.amount.toFixed(0)} {expense.currency})</div>
                                        </div>
                                        <div style={{width:'32px'}}></div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })}
        </div>
    );
}

// â”€â”€ HUVUDAPP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
    const [currentUser, setCurrentUser] = useState(null);
    const [users, setUsers] = useState([]);
    const [trips, setTrips] = useState([]);
    const [expenses, setExpenses] = useState([]);
    const [activeTab, setActiveTab] = useState('expenses');
    const [selectedTrip, setSelectedTrip] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
    const [showAdmin, setShowAdmin] = useState(false);

    useEffect(() => {
        if (currentUser) {
            loadData();
            try {
                const saved = localStorage.getItem('resebudget_cats_' + currentUser.id);
                if (saved) setCategories(JSON.parse(saved));
            } catch(e) {}
        }
    }, [currentUser]);

    const saveCategories = (cats) => {
        setCategories(cats);
        try { localStorage.setItem('resebudget_cats_' + currentUser.id, JSON.stringify(cats)); } catch(e) {}
    };

    const loadData = async () => {
        try {
            setLoading(true);
            const [{ data: usersData }, { data: tripsData }, { data: expensesData }] = await Promise.all([
                supabase.from('users').select('*'),
                supabase.from('trips').select('*').order('created_at', { ascending: false }),
                supabase.from('expenses').select('*').order('date', { ascending: false })
            ]);
            setUsers(usersData || []);
            setTrips(tripsData || []);
            setExpenses(expensesData || []);
            setLoading(false);
        } catch (err) {
            setError('Kunde inte ladda data: ' + err.message);
            setLoading(false);
        }
    };

    const handleAddTrip = async (trip) => {
        const { data, error } = await supabase.from('trips').insert([{ ...trip, created_by: currentUser.id }]).select();
        if (!error && data) { setTrips([data[0], ...trips]); setSelectedTrip(data[0].id); }
    };

    const handleCompleteTrip = async (id) => {
        const { error } = await supabase.from('trips').update({ is_completed: true }).eq('id', id);
        if (!error) {
            setTrips(trips.map(t => t.id === id ? { ...t, is_completed: true } : t));
            if (selectedTrip === id) setSelectedTrip(null);
        }
    };

    const handleDeleteTrip = async (id) => {
        await supabase.from('expenses').delete().eq('trip_id', id);
        const { error } = await supabase.from('trips').delete().eq('id', id);
        if (!error) {
            setTrips(trips.filter(t => t.id !== id));
            setExpenses(expenses.filter(e => e.trip_id !== id));
            if (selectedTrip === id) setSelectedTrip(null);
        }
    };

    const handleAddExpense = async (expense) => {
        const { data, error } = await supabase.from('expenses').insert([{ ...expense, trip_id: selectedTrip, added_by: currentUser.id }]).select();
        if (!error && data) setExpenses([data[0], ...expenses]);
    };

    const handleDeleteExpense = async (id) => {
        const { error } = await supabase.from('expenses').delete().eq('id', id);
        if (!error) setExpenses(expenses.filter(e => e.id !== id));
    };

    if (!currentUser) return <LoginForm onLogin={setCurrentUser} />;
    if (loading) return <div className="loading"><div className="spinner"/><p>Laddar data...</p></div>;

    return (
        <div className="app-container">
            <Header
                user={currentUser}
                onLogout={() => setCurrentUser(null)}
                onAdminClick={() => setShowAdmin(true)}
            />
            {error && <div className="alert alert-error">{error}</div>}

            {showAdmin && currentUser.is_admin && (
                <div className="modal-overlay" onClick={() => setShowAdmin(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth:'700px'}}>
                        <div className="modal-header">
                            <span className="modal-title">âš™ï¸ Admin</span>
                            <button className="close-btn" onClick={() => setShowAdmin(false)}>Ã—</button>
                        </div>
                        <AdminView
                            users={users}
                            onAddUser={async (user) => {
                                const { data, error } = await supabase.from('users').insert([user]).select();
                                if (!error && data) setUsers([...users, data[0]]);
                            }}
                            onDeleteUser={async (id) => {
                                const { error } = await supabase.from('users').delete().eq('id', id);
                                if (!error) setUsers(users.filter(u => u.id !== id));
                            }}
                            onResetPassword={async (id, newPassword) => {
                                const { error } = await supabase.from('users').update({ password: newPassword }).eq('id', id);
                                if (!error) setUsers(users.map(u => u.id === id ? { ...u, password: newPassword } : u));
                            }}
                            onToggleAdmin={async (id, isAdmin) => {
                                const { error } = await supabase.from('users').update({ is_admin: isAdmin }).eq('id', id);
                                if (!error) setUsers(users.map(u => u.id === id ? { ...u, is_admin: isAdmin } : u));
                            }}
                        />
                    </div>
                </div>
            )}

            <div className="main-content">
                <div className="tabs">
                    <button className={`tab ${activeTab==='planned'?'active':''}`} onClick={() => setActiveTab('planned')}>ğŸ—“ Planerade Resor</button>
                    <button className={`tab ${activeTab==='expenses'?'active':''}`} onClick={() => setActiveTab('expenses')}>ğŸ’¸ Utgifter</button>
                    <button className={`tab ${activeTab==='history'?'active':''}`} onClick={() => setActiveTab('history')}>ğŸ“‚ Avslutade Resor</button>
                </div>

                {activeTab === 'planned' && (
                    <PlannedTripsView />
                )}

                {activeTab === 'expenses' && (
                    <ExpensesView
                        trips={trips}
                        selectedTrip={selectedTrip}
                        onSelectTrip={setSelectedTrip}
                        expenses={expenses.filter(e => !selectedTrip || e.trip_id === selectedTrip)}
                        allExpenses={expenses}
                        users={users}
                        currentUser={currentUser}
                        categories={categories}
                        onAddCategory={cat => saveCategories([...categories, cat])}
                        onDeleteCategory={id => saveCategories(categories.filter(c => c.id !== id))}
                        onAddTrip={handleAddTrip}
                        onDeleteTrip={handleDeleteTrip}
                        onCompleteTrip={handleCompleteTrip}
                        onAddExpense={handleAddExpense}
                        onDeleteExpense={handleDeleteExpense}
                    />
                )}

                {activeTab === 'history' && (
                    <CompletedTripsView
                        trips={trips.filter(t => t.is_completed)}
                        allExpenses={expenses}
                        onDeleteTrip={handleDeleteTrip}
                    />
                )}
            </div>
        </div>
    );
}

// â”€â”€ PLANERADE RESOR (PLACEHOLDER) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PlannedTripsView() {
    return (
        <div className="placeholder-box">
            <div className="placeholder-icon">ğŸ—“ï¸</div>
            <div className="placeholder-title">Planerade Resor</div>
            <div className="placeholder-desc">HÃ¤r kommer du kunna planera och organisera kommande resor. Funktionen Ã¤r under uppbyggnad.</div>
        </div>
    );
}

// â”€â”€ AVSLUTADE RESOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CompletedTripsView({ trips, allExpenses, onDeleteTrip }) {
    const [confirm, setConfirm] = useState(null);

    const getTripTotal = (tripId) =>
        allExpenses.filter(e => e.trip_id === tripId).reduce((sum, e) => sum + e.amount * e.exchange_rate, 0);

    const getTripIcons = ['âœˆï¸','ğŸŒ','ğŸï¸','ğŸ—ºï¸','ğŸš€','â›µ','ğŸ”ï¸','ğŸ’'];
    const getTripIcon = (tripId) => {
        const idx = parseInt(String(tripId).replace(/\D/g, '').slice(-1)) % getTripIcons.length;
        return getTripIcons[idx] || 'âœˆï¸';
    };

    if (trips.length === 0) {
        return (
            <div className="placeholder-box">
                <div className="placeholder-icon">ğŸ“‚</div>
                <div className="placeholder-title">Inga avslutade resor</div>
                <div className="placeholder-desc">Resor du avslutar frÃ¥n Utgifter-fliken dyker upp hÃ¤r.</div>
            </div>
        );
    }

    return (
        <div>
            {confirm && (
                <ConfirmDialog
                    title="Ta bort avslutad resa?"
                    message={`"${confirm.name}" och alla dess utgifter raderas permanent. Det gÃ¥r inte att Ã¥ngra.`}
                    onConfirm={() => { onDeleteTrip(confirm.id); setConfirm(null); }}
                    onCancel={() => setConfirm(null)}
                />
            )}
            <div className="trip-cards-grid" style={{marginBottom:'2rem'}}>
                {trips.map(trip => {
                    const count = allExpenses.filter(e => e.trip_id === trip.id).length;
                    const total = getTripTotal(trip.id);
                    const hasBudget = trip.budget && trip.budget > 0;
                    const underBudget = hasBudget && total <= trip.budget;
                    return (
                        <div key={trip.id} className="trip-card completed" style={{cursor:'default'}}>
                            <div className="trip-card-icon">{getTripIcon(trip.id)}</div>
                            <div className="trip-card-name">{trip.name}</div>
                            <span className="completed-badge">âœ“ Avslutad</span>
                            <div className="trip-card-meta">{count} {count === 1 ? 'utgift' : 'utgifter'}{hasBudget ? ` Â· Budget: ${trip.budget.toFixed(0)} kr` : ''}</div>
                            {hasBudget && <BudgetBar budget={trip.budget} spent={total} />}
                            {hasBudget && (
                                <div style={{fontSize:'0.8rem', color: underBudget ? 'var(--success)' : 'var(--error)', fontWeight:600}}>
                                    {underBudget
                                        ? `âœ“ HÃ¶ll budgeten! Sparade ${(trip.budget - total).toFixed(0)} kr`
                                        : `âš ï¸ Ã–verskred budgeten med ${(total - trip.budget).toFixed(0)} kr`}
                                </div>
                            )}
                            <div className="trip-card-footer">
                                <span className="trip-card-total">{total > 0 ? `${total.toFixed(0)} kr` : 'â€“'}</span>
                                <button
                                    className="trip-card-del"
                                    title="Ta bort resa"
                                    onClick={() => setConfirm({ id: trip.id, name: trip.name })}
                                >ğŸ—‘</button>
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

// â”€â”€ INLOGGNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginForm({ onLogin }) {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true); setError('');
        try {
            const { data, error } = await supabase.from('users').select('*').eq('username', username).eq('password', password).single();
            if (error || !data) setError('Fel anvÃ¤ndarnamn eller lÃ¶senord');
            else onLogin(data);
        } catch (err) { setError('Fel vid inloggning: ' + err.message); }
        setLoading(false);
    };

    return (
        <div className="login-container">
            <h1 className="login-title">âœˆï¸ Resebudget</h1>
            {error && <div className="alert alert-error">{error}</div>}
            <form onSubmit={handleSubmit}>
                <div className="form-group">
                    <label className="form-label">AnvÃ¤ndarnamn</label>
                    <input type="text" className="form-input" value={username} onChange={e => setUsername(e.target.value)} required disabled={loading} />
                </div>
                <div className="form-group">
                    <label className="form-label">LÃ¶senord</label>
                    <input type="password" className="form-input" value={password} onChange={e => setPassword(e.target.value)} required disabled={loading} />
                </div>
                <button type="submit" className="btn btn-primary" style={{width:'100%'}} disabled={loading}>
                    {loading ? 'Loggar in...' : 'Logga in'}
                </button>
            </form>
        </div>
    );
}

// â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Header({ user, onLogout, onAdminClick }) {
    return (
        <header className="header">
            <div className="logo">âœˆï¸ Resebudget</div>
            <div className="user-info">
                {user.is_admin ? (
                    <span className="user-badge admin-badge" onClick={onAdminClick} title="Ã–ppna adminpanelen">
                        {user.name} (Admin) âš™ï¸
                    </span>
                ) : (
                    <span className="user-badge">{user.name}</span>
                )}
                <button className="btn btn-secondary btn-small" onClick={onLogout}>Logga ut</button>
            </div>
        </header>
    );
}

// â”€â”€ UTGIFTSVY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ExpensesView({ trips, selectedTrip, onSelectTrip, expenses, allExpenses, users, currentUser, categories, onAddCategory, onDeleteCategory, onAddTrip, onDeleteTrip, onCompleteTrip, onAddExpense, onDeleteExpense }) {
    const [description, setDescription] = useState('');
    const [amount, setAmount] = useState('');
    const [currency, setCurrency] = useState('SEK');
    const [category, setCategory] = useState('food');
    const [expenseDate, setExpenseDate] = useState(new Date().toISOString().split('T')[0]);
    const [submitting, setSubmitting] = useState(false);
    const [showCatManager, setShowCatManager] = useState(false);
    const [confirm, setConfirm] = useState(null);
    const [expenseView, setExpenseView] = useState('list'); // 'list' | 'day'

    const handleAddExpense = async (e) => {
        e.preventDefault();
        if (!description || !amount || submitting || !selectedTrip) return;
        setSubmitting(true);
        const sel = CURRENCIES.find(c => c.code === currency);
        await onAddExpense({ description, amount: parseFloat(amount), currency, exchange_rate: sel.rate, category, date: new Date(expenseDate).toISOString() });
        setDescription(''); setAmount(''); setCategory('food');
        setExpenseDate(new Date().toISOString().split('T')[0]);
        setSubmitting(false);
    };

    const handleDeleteTripConfirm = (id, name) => {
        setConfirm({ type: 'trip', id, name });
    };

    const getCatInfo = (id) => categories.find(c => c.id === id) || { icon: 'ğŸ“Œ', name: id };
    const getUserName = (uid) => users.find(u => u.id === uid)?.name || 'OkÃ¤nd';

    const totalSEK = expenses.reduce((sum, e) => sum + (e.amount * e.exchange_rate), 0);
    const categoryTotals = categories.map(cat => ({
        ...cat,
        total: expenses.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount * e.exchange_rate, 0)
    })).filter(c => c.total > 0);

    return (
        <div>
            {confirm && (
                <ConfirmDialog
                    title={confirm.type === 'trip' ? 'Ta bort resa?' : confirm.type === 'complete' ? 'Avsluta resa?' : 'Ta bort utgift?'}
                    message={confirm.type === 'trip'
                        ? `"${confirm.name}" och alla dess utgifter raderas permanent. Det gÃ¥r inte att Ã¥ngra.`
                        : confirm.type === 'complete'
                        ? `"${confirm.name}" markeras som avslutad och flyttas till Avslutade Resor. Du kan fortfarande se den dÃ¤r.`
                        : `"${confirm.name}" raderas permanent.`}
                    confirmLabel={confirm.type === 'complete' ? 'Avsluta resa' : 'Ta bort'}
                    onConfirm={() => {
                        if (confirm.type === 'trip') onDeleteTrip(confirm.id);
                        else if (confirm.type === 'complete') onCompleteTrip(confirm.id);
                        else onDeleteExpense(confirm.id);
                        setConfirm(null);
                    }}
                    onCancel={() => setConfirm(null)}
                />
            )}

            {/* RESAKORT */}
            <TripCards
                trips={trips}
                selectedTrip={selectedTrip}
                onSelectTrip={onSelectTrip}
                allExpenses={allExpenses}
                onAddTrip={onAddTrip}
                onDeleteTrip={handleDeleteTripConfirm}
                onCompleteTrip={(id, name) => setConfirm({ type:'complete', id, name })}
            />

            {!selectedTrip ? (
                <div className="card" style={{textAlign:'center', padding:'3rem'}}>
                    <p style={{color:'var(--text-muted)'}}>VÃ¤lj en resa ovan fÃ¶r att se och lÃ¤gga till utgifter</p>
                </div>
            ) : (
                <>
                    {/* KATEGORIER */}
                    <div style={{marginBottom:'0.5rem'}}>
                        <button
                            className="btn btn-secondary btn-small"
                            style={{marginBottom:'0.75rem'}}
                            onClick={() => setShowCatManager(!showCatManager)}
                        >
                            {showCatManager ? 'â–² DÃ¶lj kategorier' : 'âš™ Hantera kategorier'}
                        </button>
                        {showCatManager && (
                            <CategoryManager
                                categories={categories}
                                onAdd={onAddCategory}
                                onDelete={onDeleteCategory}
                            />
                        )}
                    </div>

                    {/* LÃ„GG TILL UTGIFT */}
                    <form onSubmit={handleAddExpense} className="quick-add-form">
                        <h3 style={{marginBottom:'1rem', fontSize:'1.25rem'}}>âš¡ LÃ¤gg till utgift</h3>
                        <div className="quick-add-grid">
                            <div className="form-group" style={{marginBottom:0}}>
                                <input type="text" className="form-input" placeholder="Vad kÃ¶pte du?" value={description} onChange={e => setDescription(e.target.value)} required disabled={submitting} />
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <input type="number" step="0.01" className="form-input" placeholder="Belopp" value={amount} onChange={e => setAmount(e.target.value)} required disabled={submitting} />
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <select className="form-select" value={currency} onChange={e => setCurrency(e.target.value)} disabled={submitting}>
                                    {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code}</option>)}
                                </select>
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <select className="form-select" value={category} onChange={e => setCategory(e.target.value)} disabled={submitting}>
                                    {categories.map(c => <option key={c.id} value={c.id}>{c.icon} {c.name}</option>)}
                                </select>
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <input type="date" className="form-input" value={expenseDate} onChange={e => setExpenseDate(e.target.value)} disabled={submitting} required />
                            </div>
                            <button type="submit" className="btn btn-secondary" disabled={submitting || !selectedTrip}>
                                {submitting ? '...' : 'LÃ¤gg till'}
                            </button>
                        </div>
                    </form>

                    {/* STATISTIK â€“ bara total och antal */}
                    <div className="grid" style={{gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))'}}>
                        <div className="card stat-card">
                            <div className="stat-value">{totalSEK.toFixed(0)} kr</div>
                            <div className="stat-label">Total</div>
                        </div>
                        <div className="card stat-card">
                            <div className="stat-value">{expenses.length}</div>
                            <div className="stat-label">Utgifter</div>
                        </div>
                    </div>

                    {/* PER KATEGORI */}
                    {categoryTotals.length > 0 && (
                        <div className="card" style={{marginBottom:'2rem'}}>
                            <h3 className="card-title" style={{marginBottom:'1rem'}}>Per Kategori</h3>
                            <div className="expense-list">
                                {categoryTotals.map(cat => (
                                    <div key={cat.id} style={{display:'flex', justifyContent:'space-between', padding:'0.75rem', background:'var(--bg)', borderRadius:'6px'}}>
                                        <span>{cat.icon} {cat.name}</span>
                                        <span style={{fontFamily:'Space Mono', fontWeight:700}}>{cat.total.toFixed(0)} kr</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* UTGIFTSLISTA MED DAGÃ–VERSIKT */}
                    <div className="card">
                        <div className="card-header">
                            <h3 className="card-title">Alla utgifter</h3>
                            {expenses.length > 0 && (
                                <div className="view-toggle">
                                    <span className="view-toggle-label">Visa:</span>
                                    <button className={`toggle-btn ${expenseView==='list'?'active':''}`} onClick={() => setExpenseView('list')}>Lista</button>
                                    <button className={`toggle-btn ${expenseView==='day'?'active':''}`} onClick={() => setExpenseView('day')}>Per dag</button>
                                </div>
                            )}
                        </div>

                        {expenses.length === 0 ? (
                            <p style={{textAlign:'center', color:'var(--text-muted)', padding:'2rem'}}>Inga utgifter Ã¤nnu</p>
                        ) : expenseView === 'list' ? (
                            <div className="expense-list">
                                {expenses.map(expense => {
                                    const cat = getCatInfo(expense.category);
                                    return (
                                        <div key={expense.id} className="expense-item">
                                            <div className="expense-category">{cat.icon}</div>
                                            <div className="expense-details">
                                                <div className="expense-description">{expense.description}</div>
                                                <div className="expense-meta">
                                                    {cat.name} Â· {getUserName(expense.added_by)} Â· {new Date(expense.date).toLocaleDateString('sv-SE')}
                                                </div>
                                            </div>
                                            <div className="expense-amount">
                                                <div className="expense-price">{(expense.amount * expense.exchange_rate).toFixed(0)} kr</div>
                                                <div className="expense-currency">({expense.amount.toFixed(0)} {expense.currency})</div>
                                            </div>
                                            <button
                                                className="btn btn-danger btn-icon btn-small"
                                                title="Ta bort utgift"
                                                onClick={() => setConfirm({ type:'expense', id:expense.id, name:expense.description })}
                                            >ğŸ—‘</button>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <DayBreakdown expenses={expenses} categories={categories} users={users} />
                        )}
                    </div>
                </>
            )}
        </div>
    );
}

// â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AdminView({ users, onAddUser, onDeleteUser, onResetPassword, onToggleAdmin }) {
    const [showAddUser, setShowAddUser] = useState(false);
    const [newUser, setNewUser] = useState({ username:'', password:'', name:'', is_admin:false });
    const [submitting, setSubmitting] = useState(false);

    const handleAddUser = async (e) => {
        e.preventDefault();
        setSubmitting(true);
        await onAddUser(newUser);
        setNewUser({ username:'', password:'', name:'', is_admin:false });
        setShowAddUser(false);
        setSubmitting(false);
    };

    return (
        <div>
            <div style={{marginBottom:'1.5rem'}}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                    <h3 style={{fontSize:'1.1rem', fontWeight:700, color:'var(--text)'}}>AnvÃ¤ndare</h3>
                    <button className="btn btn-primary btn-small" onClick={() => setShowAddUser(!showAddUser)}>+ LÃ¤gg till anvÃ¤ndare</button>
                </div>

                {showAddUser && (
                    <form onSubmit={handleAddUser} style={{marginBottom:'1.5rem', padding:'1rem', background:'var(--bg)', borderRadius:'8px'}}>
                        {[['Namn','name','text'],['AnvÃ¤ndarnamn','username','text'],['LÃ¶senord','password','password']].map(([label, key, type]) => (
                            <div className="form-group" key={key}>
                                <label className="form-label">{label}</label>
                                <input type={type} className="form-input" value={newUser[key]} onChange={e => setNewUser({...newUser, [key]: e.target.value})} required disabled={submitting} />
                            </div>
                        ))}
                        <div className="form-group">
                            <label style={{display:'flex', alignItems:'center', gap:'0.5rem', cursor:'pointer'}}>
                                <input type="checkbox" checked={newUser.is_admin} onChange={e => setNewUser({...newUser, is_admin: e.target.checked})} disabled={submitting} />
                                Admin-rÃ¤ttigheter
                            </label>
                        </div>
                        <button type="submit" className="btn btn-primary" disabled={submitting}>
                            {submitting ? 'Skapar...' : 'Skapa anvÃ¤ndare'}
                        </button>
                    </form>
                )}

                <div className="user-list">
                    {users.map(user => (
                        <div key={user.id} className="user-item">
                            <div className="user-item-info">
                                <div className="user-avatar">{user.name.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style={{fontWeight:500}}>{user.name}</div>
                                    <div style={{fontSize:'0.875rem', color:'var(--text-muted)'}}>@{user.username}{user.is_admin && ' Â· Admin'}</div>
                                </div>
                            </div>
                            <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap'}}>
                                <button className="btn btn-secondary btn-small" onClick={() => { const p = prompt('Nytt lÃ¶senord fÃ¶r ' + user.name); if (p) onResetPassword(user.id, p); }}>Ã…terstÃ¤ll lÃ¶senord</button>
                                <button className={`btn btn-small ${user.is_admin ? 'btn-secondary' : 'btn-primary'}`} onClick={() => { if (confirm(`${user.is_admin ? 'Ta bort' : 'Ge'} admin fÃ¶r ${user.name}?`)) onToggleAdmin(user.id, !user.is_admin); }}>
                                    {user.is_admin ? 'â¬‡ï¸ Ta bort admin' : 'â¬†ï¸ GÃ¶r till admin'}
                                </button>
                                <button className="btn btn-danger btn-small" onClick={() => { if (confirm('Ta bort ' + user.name + '? Det gÃ¥r inte att Ã¥ngra.')) onDeleteUser(user.id); }}>Ta bort</button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
