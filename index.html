<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VÃ¥ra resor</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #2F6F4E;
            --primary-light: #6FAF8E;
            --accent: #F4B860;
            --bg: #E6F2EC;
            --card: #FFFFFF;
            --text: #1F2D26;
            --text-muted: #5A7566;
            --border: #C8DDD3;
            --success: #2F6F4E;
            --warning: #F4B860;
            --error: #C0392B;
            --danger: #C0392B;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .app-container { min-height: 100vh; padding: 2rem; }

        .header {
            max-width: 1400px; margin: 0 auto 0;
            display: flex; flex-direction: column; align-items: center;
            padding: 1.5rem 0 1.25rem;
            position: relative;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(to right,
                transparent 0%,
                var(--primary-light) 15%,
                var(--primary) 40%,
                var(--accent) 60%,
                var(--primary) 80%,
                transparent 100%
            );
            border-radius: 2px;
            opacity: 0.7;
        }
        .header-spacer {
            height: 2rem;
        }
        .logo { font-family: 'Space Mono', monospace; font-size: 1.8rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-badge {
            background: var(--primary); color: white; padding: 0.5rem 1rem;
            border-radius: 20px; font-size: 0.9rem; font-weight: 500;
            cursor: default;
        }
        .user-badge.admin-badge {
            background: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .user-badge.admin-badge:hover {
            background: #e0a450;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(244,184,96,0.4);
        }

        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: #255c40; transform: translateY(-2px); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover:not(:disabled) { background: var(--primary); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-danger:hover:not(:disabled) { background: #c62828; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-icon { padding: 0.35rem 0.6rem; font-size: 0.9rem; border-radius: 6px; line-height: 1; }

        .main-content { max-width: 1400px; margin: 0 auto; }

        .login-container { max-width: 400px; margin: 5rem auto; background: var(--card); padding: 3rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(47,111,78,0.1); }
        .login-title { font-family: 'Space Mono', monospace; font-size: 2rem; margin-bottom: 2rem; text-align: center; color: var(--primary); }

        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); }
        .form-input { width: 100%; padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 1rem; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-select { width: 100%; padding: 0.875rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 1rem; background: white; cursor: pointer; }

        /* TABS */
        .tabs {
            display: flex; gap: 0; margin-bottom: 2rem;
            background: white; border-radius: 12px; padding: 0.4rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07); border: 1px solid var(--border);
            width: fit-content;
            margin-left: auto; margin-right: auto;
        }
        .tab {
            padding: 0.75rem 1.75rem; background: none; border: none;
            font-family: 'Inter', sans-serif; font-size: 0.95rem; font-weight: 500;
            color: var(--text-muted); cursor: pointer; border-radius: 8px;
            transition: all 0.2s; position: relative; white-space: nowrap;
        }
        .tab.active {
            background: var(--primary); color: white;
            box-shadow: 0 2px 8px rgba(47,111,78,0.3);
        }
        .tab:not(.active):hover { color: var(--primary); background: #d4eadd; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--card); padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .card-title { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .stat-card { text-align: center; padding: 2rem; }
        .stat-value { font-family: 'Space Mono', monospace; font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-muted); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }

        /* TRIP CARDS */
        .trip-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }
        .trip-card {
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.25s;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 240px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            border: 2.5px solid transparent;
        }
        .trip-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 28px rgba(0,0,0,0.22);
        }
        .trip-card.selected {
            border-color: var(--primary);
            box-shadow: 0 6px 24px rgba(44,95,45,0.35);
        }
        /* Image layer */
        .tc-img {
            position: absolute; inset: 0;
            background-size: cover; background-position: center;
            transition: transform 0.4s;
        }
        .trip-card:hover .tc-img { transform: scale(1.04); }
        .tc-img-placeholder {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, #1a3a2a 0%, #2F6F4E 60%, #6FAF8E 100%);
        }
        /* Dark gradient overlay for legibility */
        .tc-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to bottom,
                rgba(0,0,0,0.08) 0%,
                rgba(0,0,0,0.15) 30%,
                rgba(0,0,0,0.65) 70%,
                rgba(0,0,0,0.82) 100%);
        }
        /* Content sits above image */
        .tc-content {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; padding: 0;
        }
        /* Top bar: flag + badges */
        .tc-top {
            display: flex; align-items: flex-start; justify-content: space-between;
            padding: 0.9rem 1rem 0;
        }
        .tc-flag {
            font-size: 2.2rem; line-height: 1;
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.5));
        }
        .tc-badge {
            font-size: 0.68rem; font-weight: 700; border-radius: 20px;
            padding: 0.2rem 0.55rem; backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.25);
        }
        .tc-badge-planned { background: rgba(255,193,7,0.85); color: #333; }
        .tc-badge-active  { background: rgba(47,111,78,0.9); color: white; }
        .tc-badge-done    { background: rgba(255,255,255,0.2); color: white; }
        /* Bottom content */
        .tc-bottom {
            margin-top: auto;
            padding: 0.75rem 1rem 1rem;
        }
        .tc-name {
            font-weight: 800; font-size: 1.1rem; color: white;
            line-height: 1.25; margin-bottom: 0.3rem;
            text-shadow: 0 1px 4px rgba(0,0,0,0.5);
        }
        .tc-meta {
            font-size: 0.75rem; color: rgba(255,255,255,0.8);
            margin-bottom: 0.6rem; line-height: 1.4;
        }
        .tc-total {
            font-family: 'Space Mono', monospace;
            font-size: 1rem; font-weight: 700; color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .tc-actions {
            display: flex; flex-direction: column; gap: 0.35rem; margin-top: 0.6rem;
        }
        .tc-actions .btn {
            backdrop-filter: blur(8px);
        }
        .tc-actions .btn-primary {
            background: rgba(47,111,78,0.9); border-color: rgba(255,255,255,0.2);
        }
        .tc-actions .btn-secondary {
            background: rgba(255,255,255,0.18); color: white; border-color: rgba(255,255,255,0.3);
        }
        .tc-actions .btn-secondary:hover { background: rgba(255,255,255,0.28); }
        .tc-actions .btn-danger {
            background: rgba(183,28,28,0.75); border-color: rgba(255,255,255,0.2); color: white;
        }
        /* Budget bar on cards */
        .tc-budget-bar {
            height: 3px; background: rgba(255,255,255,0.2);
            border-radius: 2px; margin-bottom: 0.5rem; overflow: hidden;
        }
        .tc-budget-fill {
            height: 100%; border-radius: 2px; transition: width 0.5s;
        }
        .trip-card-del {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25);
            backdrop-filter: blur(4px); cursor: pointer;
            color: white; font-size: 1rem; padding: 0.3rem 0.5rem;
            border-radius: 6px; transition: all 0.15s; line-height: 1;
        }
        .trip-card-del:hover { background: rgba(183,28,28,0.6); }
        .trip-card-total { font-family: 'Space Mono', monospace; font-size: 0.95rem; font-weight: 700; color: white; }
        .trip-card-new {
            border: 2px dashed var(--border);
            background: transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 0.5rem; color: var(--text-muted); min-height: 240px;
            font-size: 0.95rem; font-weight: 500;
        }
        .trip-card-new:hover {
            border-color: var(--primary-light); color: var(--primary);
            background: #f9fff9; transform: translateY(-2px);
        }
        .trip-card-new .plus-icon { font-size: 1.8rem; color: var(--primary-light); }

        /* EXPENSE LIST */
        .expense-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .expense-item { background: var(--card); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); display: grid; grid-template-columns: auto 1fr auto auto; gap: 1rem; align-items: center; transition: background 0.15s; }
        .expense-item:hover { background: #fafafa; }
        .expense-category { width: 46px; height: 46px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; background: var(--bg); flex-shrink: 0; }
        .expense-details { min-width: 0; }
        .expense-description { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .expense-meta { font-size: 0.875rem; color: var(--text-muted); }
        .expense-amount { text-align: right; white-space: nowrap; }
        .expense-price { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; }
        .expense-currency { font-size: 0.75rem; color: var(--text-muted); }

        .quick-add-form { background: var(--primary); padding: 1.5rem; border-radius: 12px; color: white; margin-bottom: 2rem; }
        .quick-add-form .form-input, .quick-add-form .form-select { background: rgba(255,255,255,0.95); }
        .quick-add-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end; }

        /* CATEGORY MANAGER */
        .cat-section { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .cat-section-title { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .cat-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .cat-chip { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.65rem; border-radius: 20px; font-size: 0.85rem; background: white; border: 1px solid var(--border); }
        .cat-chip-del { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; line-height: 1; padding: 0 0 0 0.1rem; transition: color 0.15s; }
        .cat-chip-del:hover { color: var(--error); }
        .cat-add-row { display: flex; gap: 0.5rem; align-items: center; }
        .cat-add-row input { flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; font-family: 'Inter', sans-serif; }
        .cat-add-row input:focus { outline: none; border-color: var(--primary); }
        .emoji-picker { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.6rem; }
        .emoji-btn { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 0.2rem 0.4rem; font-size: 1.1rem; cursor: pointer; transition: all 0.15s; }
        .emoji-btn:hover { border-color: var(--primary); }
        .emoji-btn.active { background: var(--primary); border-color: var(--primary); }

        /* DAY BREAKDOWN */
        .day-breakdown { margin-top: 2rem; }
        .day-group { margin-bottom: 1.25rem; }
        .day-group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 1rem; background: var(--primary); color: white;
            border-radius: 8px 8px 0 0; font-weight: 600; font-size: 0.95rem;
        }
        .day-group-total { font-family: 'Space Mono', monospace; font-size: 0.9rem; }
        .day-group-items { border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; overflow: hidden; }
        .day-group-items .expense-item { border-radius: 0; border: none; border-bottom: 1px solid var(--border); }
        .day-group-items .expense-item:last-child { border-bottom: none; }

        /* CONFIRM MODAL */
        .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 200; padding: 1rem; }
        .confirm-box { background: white; border-radius: 12px; padding: 2rem; max-width: 360px; width: 100%; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        .confirm-box h3 { font-size: 1.2rem; margin-bottom: 0.5rem; }
        .confirm-box p { color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.5; }
        .confirm-btns { display: flex; gap: 0.75rem; }
        .confirm-btns .btn { flex: 1; justify-content: center; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 2rem; }
        .modal { background: var(--card); padding: 2rem; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .close-btn:hover { background: var(--border); color: var(--text); }

        .user-list { display: flex; flex-direction: column; gap: 1rem; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg); border-radius: 8px; }
        .user-item-info { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; }

        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .alert-success { background: #E8F5E9; color: #2E7D32; border: 1px solid #4CAF50; }
        .alert-error { background: #FFEBEE; color: #C62828; border: 1px solid #EF5350; }
        .loading { text-align: center; padding: 3rem; color: var(--text-muted); }
        .spinner { border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* PLACEHOLDER */
        .placeholder-box {
            text-align: center; padding: 5rem 2rem;
            background: var(--card); border-radius: 16px;
            border: 2px dashed var(--border);
        }
        .placeholder-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.4; }
        .placeholder-title { font-size: 1.4rem; font-weight: 700; color: var(--text-muted); margin-bottom: 0.5rem; }
        .placeholder-desc { color: var(--text-muted); font-size: 0.95rem; max-width: 350px; margin: 0 auto; }

        /* NEW TRIP MODAL */
        .new-trip-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 150; padding: 1rem; }
        .new-trip-box { background: white; border-radius: 14px; padding: 2rem; max-width: 420px; width: 100%; box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        .new-trip-box h3 { font-size: 1.3rem; font-weight: 700; color: var(--primary); margin-bottom: 1.25rem; }

        /* VIEW TOGGLE */
        .view-toggle { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; }
        .view-toggle-label { font-size: 0.85rem; color: var(--text-muted); margin-right: 0.25rem; }
        .toggle-btn { padding: 0.4rem 0.9rem; border-radius: 20px; border: 1.5px solid var(--border); background: white; font-family: 'Inter', sans-serif; font-size: 0.85rem; cursor: pointer; color: var(--text-muted); transition: all 0.15s; }
        .toggle-btn.active { background: var(--primary); border-color: var(--primary); color: white; font-weight: 600; }


        /* PLANNING PANEL */
        .planning-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150; display: flex; align-items: stretch; justify-content: flex-end; }
        .planning-panel { background: var(--card); width: min(780px, 100vw); height: 100vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: -4px 0 30px rgba(0,0,0,0.15); }
        .planning-panel-header { position: sticky; top: 0; z-index: 10; background: var(--primary); color: white; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .planning-panel-body { flex: 1; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .editable-title-input { font-family: Space Mono, monospace; font-size: 1.1rem; font-weight: 700; color: white; background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 0.3rem 0.6rem; outline: none; flex: 1; min-width: 0; }
        .editable-title-input:focus { background: rgba(255,255,255,0.25); border-color: white; }
        .budget-inline-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(255,255,255,0.8); flex-wrap: wrap; }
        .budget-inline-input { background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 0.25rem 0.5rem; color: white; font-family: Space Mono, monospace; font-size: 0.85rem; width: 110px; outline: none; }
        .budget-inline-input:focus { background: rgba(255,255,255,0.25); border-color: white; }
        .budget-inline-input::placeholder { color: rgba(255,255,255,0.5); }
        .dest-card { background: var(--bg); border: 1.5px solid var(--border); border-radius: 12px; overflow: hidden; }
        .dest-card-header { background: white; padding: 0.9rem 1.25rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--border); }
        .dest-number { width: 26px; height: 26px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; flex-shrink: 0; }
        .dest-name-input { flex: 1; border: 1.5px solid var(--border); border-radius: 6px; padding: 0.4rem 0.7rem; font-family: Inter, sans-serif; font-size: 0.95rem; font-weight: 600; }
        .dest-name-input:focus { outline: none; border-color: var(--primary); }
        .dest-body { padding: 1.1rem 1.25rem; display: flex; flex-direction: column; gap: 1rem; }
        .dates-row { display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap; }
        .date-field { display: flex; flex-direction: column; gap: 0.25rem; flex: 1; min-width: 120px; }
        .date-label { font-size: 0.72rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .date-input { padding: 0.45rem 0.65rem; border: 1.5px solid var(--border); border-radius: 6px; font-family: Inter, sans-serif; font-size: 0.88rem; }
        .date-input:focus { outline: none; border-color: var(--primary); }
        .section-label { font-size: 0.72rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.25rem; display: block; }
        .map-input-row { display: flex; gap: 0.5rem; }
        .map-input-row input { flex: 1; padding: 0.5rem 0.75rem; border: 1.5px solid var(--border); border-radius: 6px; font-size: 0.88rem; font-family: Inter, sans-serif; }
        .map-input-row input:focus { outline: none; border-color: var(--primary); }
        .map-iframe-wrap { position: relative; border-radius: 10px; overflow: hidden; border: 1.5px solid var(--border); margin-top: 0.4rem; }
        .map-iframe-wrap iframe { width: 100%; height: 200px; display: block; border: none; }
        .map-open-btn { position: absolute; bottom: 8px; right: 8px; background: white; border: 1.5px solid var(--border); border-radius: 6px; padding: 0.3rem 0.7rem; font-size: 0.78rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; transition: all 0.15s; text-decoration: none; color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .map-open-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .sight-item { background: white; border: 1.5px solid var(--border); border-radius: 8px; padding: 0.7rem 0.9rem; display: flex; flex-direction: column; gap: 0.45rem; }
        .sight-row1 { display: flex; gap: 0.5rem; align-items: center; }
        .sight-row2 { display: flex; gap: 0.5rem; align-items: center; }
        .sight-name-input { flex: 1; border: 1.5px solid var(--border); border-radius: 6px; padding: 0.35rem 0.6rem; font-size: 0.88rem; font-family: Inter, sans-serif; font-weight: 500; }
        .sight-name-input:focus { outline: none; border-color: var(--primary); }
        .sight-link-input { flex: 1; border: 1.5px solid var(--border); border-radius: 6px; padding: 0.3rem 0.55rem; font-size: 0.8rem; font-family: Inter, sans-serif; color: var(--text-muted); }
        .sight-link-input:focus { outline: none; border-color: var(--primary); }
        .sight-note-input { width: 100%; border: 1.5px solid var(--border); border-radius: 6px; padding: 0.35rem 0.55rem; font-size: 0.82rem; font-family: Inter, sans-serif; resize: vertical; min-height: 48px; color: var(--text-muted); box-sizing: border-box; }
        .sight-note-input:focus { outline: none; border-color: var(--primary); }
        .sight-del-btn { color: var(--text-muted); font-size: 1rem; background: none; border: none; cursor: pointer; flex-shrink: 0; transition: color 0.15s; padding: 0.2rem; }
        .sight-del-btn:hover { color: var(--error); }
        .sight-open-btn { color: var(--primary); font-size: 1.1rem; padding: 0.2rem; background: none; border: none; cursor: pointer; text-decoration: none; flex-shrink: 0; display: inline-flex; align-items: center; }
        .sight-open-btn:hover { color: var(--accent); }
        .add-link { background: none; border: none; color: var(--primary); font-size: 0.83rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0; font-family: Inter, sans-serif; }
        .add-link:hover { color: var(--accent); }
        .sights-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .panel-save-bar { position: sticky; bottom: 0; background: white; border-top: 1px solid var(--border); padding: 1rem 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; }

        /* BUDGET BAR */
        .budget-bar-wrap { margin-top: 0.5rem; }
        .budget-bar-track { height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; }
        .budget-bar-fill { height: 100%; border-radius: 99px; transition: width 0.4s, background 0.4s; }
        .budget-bar-fill.ok { background: var(--success); }
        .budget-bar-fill.warning { background: var(--warning); }
        .budget-bar-fill.danger { background: var(--error); }
        .budget-bar-fill.over { background: var(--error); width: 100% !important; }
        .budget-labels { display: flex; justify-content: space-between; font-size: 0.72rem; margin-top: 0.3rem; color: var(--text-muted); font-family: 'Space Mono', monospace; }
        .budget-remaining { font-weight: 700; }
        .budget-remaining.danger { color: var(--error); }

        /* COMPLETED TRIP CARD */
        .trip-card.completed {
            opacity: 0.85;
            background: #fafafa;
        }
        .trip-card.completed .trip-card-name { color: var(--text-muted); }
        .completed-badge {
            display: inline-block; font-size: 0.7rem; font-weight: 700;
            background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7;
            border-radius: 20px; padding: 0.1rem 0.5rem; margin-top: 0.2rem;
            letter-spacing: 0.03em;
        }

        /* AVSLUTADE RESOR VIEW */
        .completed-trip-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 1.5rem;
            display: flex; flex-direction: column; gap: 0.75rem;
        }
        .completed-trip-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .completed-trip-name { font-weight: 700; font-size: 1.1rem; }
        .completed-trip-stats { display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.875rem; color: var(--text-muted); }
        .completed-trip-stat-val { font-family: 'Space Mono', monospace; font-weight: 700; color: var(--text); font-size: 1rem; }

        @media (max-width: 768px) {
            .app-container { padding: 1rem; }
            .header { flex-direction: column; gap: 0.75rem; text-align: center; }
            .logo { font-size: 1.4rem; }
            .tabs { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 10px; }
            .tab { padding: 0.6rem 1rem; font-size: 0.82rem; white-space: nowrap; }
            .trip-cards-grid { grid-template-columns: 1fr; gap: 0.9rem; }
            .quick-add-grid { grid-template-columns: 1fr 1fr; gap: 0.6rem; }
            .quick-add-grid > *:first-child { grid-column: 1 / -1; }
            .quick-add-grid > button { grid-column: 1 / -1; }
            .grid { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
            .stat-value { font-size: 1.6rem; }
            .stat-card { padding: 1rem; }
            .expense-item { grid-template-columns: auto 1fr auto auto; gap: 0.5rem; padding: 0.75rem; }
            .expense-category { width: 36px; height: 36px; font-size: 1.1rem; }
            .expense-price { font-size: 0.95rem; }
            .card { padding: 1rem; }
            .card-header { flex-wrap: wrap; gap: 0.5rem; }
            .planning-panel { width: 100vw; }
            .planning-panel-header { padding: 1rem; flex-wrap: wrap; gap: 0.5rem; }
            .planning-panel-body { padding: 1rem; gap: 1rem; }
            .panel-save-bar { padding: 0.75rem 1rem; }
            .dest-body { padding: 0.9rem 1rem; }
            .dates-row { flex-direction: column; gap: 0.5rem; }
            .map-iframe-wrap iframe { height: 180px; }
            .sight-item { padding: 0.6rem 0.75rem; }
            .view-toggle { flex-wrap: wrap; gap: 0.4rem; }
            .modal { padding: 1.25rem; }
            .user-item { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
            .user-item > div:last-child { width: 100%; }
            .user-item > div:last-child .btn { font-size: 0.78rem; padding: 0.4rem 0.7rem; }
        }
        @media (max-width: 480px) {
            .quick-add-grid { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
            .trip-card-footer { flex-wrap: wrap; gap: 0.5rem; }
        }
        /* PRINT / PDF EXPORT */
        @media print {
            body { background: white !important; font-size: 11pt; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page { page-break-after: always; }
            .print-section { break-inside: avoid; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const SUPABASE_URL = 'https://sxgrwpqdocluntpuotib.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4Z3J3cHFkb2NsdW50cHVvdGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwOTA5NDksImV4cCI6MjA4NjY2Njk0OX0.r9GqncCA9iH8iqhzV4YB8b-WYMd-mf2z_e8aZ8e951k';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const DEFAULT_CATEGORIES = [
    { id: 'food', name: 'Mat & Restaurang', icon: 'ğŸ½ï¸' },
    { id: 'transport', name: 'Transport', icon: 'ğŸš—' },
    { id: 'accommodation', name: 'Boende', icon: 'ğŸ¨' },
    { id: 'activities', name: 'Aktiviteter', icon: 'ğŸ­' },
    { id: 'shopping', name: 'Shopping', icon: 'ğŸ›ï¸' },
    { id: 'other', name: 'Ã–vrigt', icon: 'ğŸ“Œ' }
];

const EMOJI_OPTIONS = ['ğŸ½ï¸','ğŸš—','ğŸ¨','ğŸ­','ğŸ›ï¸','ğŸ“Œ','â˜•','ğŸº','ğŸµ','âš½','ğŸ–ï¸','ğŸ¡','ğŸ’Š','ğŸ“¸','ğŸš¢','âœˆï¸','ğŸš‚','ğŸ”ï¸','ğŸ°','ğŸ¾','ğŸ›º','ğŸ¤¿','ğŸª','ğŸ›’'];

const CURRENCY_META = [
    { code: 'SEK', symbol: 'kr' },
    { code: 'EUR', symbol: 'â‚¬' },
    { code: 'USD', symbol: '$' },
    { code: 'GBP', symbol: 'Â£' },
    { code: 'NOK', symbol: 'kr' },
    { code: 'DKK', symbol: 'kr' },
    { code: 'THB', symbol: 'à¸¿' },
    { code: 'JPY', symbol: 'Â¥' }
];
const FALLBACK_RATES = { SEK:1, EUR:11.5, USD:10.8, GBP:13.5, NOK:1.0, DKK:1.54, THB:0.31, JPY:0.073 };

function useLiveRates() {
    const [rates, setRates] = React.useState(FALLBACK_RATES);
    const [ratesUpdated, setRatesUpdated] = React.useState(null);
    React.useEffect(() => {
        fetch('https://api.frankfurter.app/latest?from=SEK&to=EUR,USD,GBP,NOK,DKK,THB,JPY')
            .then(r => r.json())
            .then(data => {
                if (data.rates) {
                    const newRates = { SEK: 1 };
                    Object.entries(data.rates).forEach(([code, rate]) => {
                        // frankfurter gives X SEK per 1 foreign â€” we want SEK per 1 foreign = 1/rate_of_foreign_in_SEK
                        // actually frankfurter from=SEK gives: 1 SEK = X foreign, so 1 foreign = 1/(X) SEK? No:
                        // from=SEK means base=SEK, so rates = { EUR: 0.087 } means 1 SEK = 0.087 EUR
                        // We want: 1 EUR = ? SEK â†’ 1 / 0.087 = 11.49 SEK âœ“
                        newRates[code] = 1 / data.rates[code];
                    });
                    setRates(newRates);
                    setRatesUpdated(new Date().toLocaleTimeString('sv-SE', {hour:'2-digit',minute:'2-digit'}));
                }
            })
            .catch(() => {}); // silently keep fallback
    }, []);
    const getCurrencies = () => CURRENCY_META.map(c => ({ ...c, rate: rates[c.code] || FALLBACK_RATES[c.code] }));
    return { getCurrencies, ratesUpdated };
}

// â”€â”€ BEKRÃ„FTELSEDIALOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ConfirmDialog({ title, message, confirmLabel = 'Ta bort', onConfirm, onCancel }) {
    return (
        <div className="confirm-overlay" onClick={onCancel}>
            <div className="confirm-box" onClick={e => e.stopPropagation()}>
                <h3>{title}</h3>
                <p>{message}</p>
                <div className="confirm-btns">
                    <button className="btn btn-secondary" onClick={onCancel}>Avbryt</button>
                    <button className="btn btn-danger" onClick={onConfirm}>{confirmLabel}</button>
                </div>
            </div>
        </div>
    );
}

// â”€â”€ KATEGORIHANTERARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CategoryManager({ categories, onAdd, onDelete }) {
    const [newName, setNewName] = useState('');
    const [newEmoji, setNewEmoji] = useState('ğŸ“Œ');

    const handleAdd = () => {
        const name = newName.trim();
        if (!name) return;
        onAdd({ id: 'custom_' + Date.now(), name, icon: newEmoji });
        setNewName('');
        setNewEmoji('ğŸ“Œ');
    };

    return (
        <div className="cat-section">
            <div className="cat-section-title">
                <span>Kategorier</span>
            </div>
            <div className="cat-chips">
                {categories.map(cat => (
                    <span key={cat.id} className="cat-chip">
                        {cat.icon} {cat.name}
                        <button
                            className="cat-chip-del"
                            onClick={() => onDelete(cat.id)}
                            title="Ta bort kategori"
                        >Ã—</button>
                    </span>
                ))}
            </div>
            <div style={{fontSize:'0.78rem', color:'var(--text-muted)', marginBottom:'0.5rem'}}>LÃ¤gg till ny kategori:</div>
            <div className="emoji-picker">
                {EMOJI_OPTIONS.map(e => (
                    <button key={e} className={`emoji-btn ${newEmoji === e ? 'active' : ''}`} onClick={() => setNewEmoji(e)}>{e}</button>
                ))}
            </div>
            <div className="cat-add-row">
                <span style={{fontSize:'1.2rem'}}>{newEmoji}</span>
                <input
                    placeholder="Kategorinamn..."
                    value={newName}
                    onChange={e => setNewName(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && handleAdd()}
                />
                <button className="btn btn-primary btn-small" onClick={handleAdd} disabled={!newName.trim()}>
                    + LÃ¤gg till
                </button>
            </div>
        </div>
    );
}

// â”€â”€ BUDGETBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BudgetBar({ budget, spent }) {
    if (!budget || budget <= 0) return null;
    const remaining = budget - spent;
    const pct = Math.min((spent / budget) * 100, 100);
    const remainingPct = remaining / budget; // can be negative
    const isOver = spent > budget;
    const isDanger = !isOver && remainingPct <= 0.25;
    const isWarning = !isOver && !isDanger && remainingPct <= 0.5;
    const fillClass = isOver ? 'over' : isDanger ? 'danger' : isWarning ? 'warning' : 'ok';

    return (
        <div className="budget-bar-wrap">
            <div className="budget-bar-track">
                <div className="budget-bar-fill" style={{width: isOver ? '100%' : `${pct}%`}} className={`budget-bar-fill ${fillClass}`}></div>
            </div>
            <div className="budget-labels">
                <span>{isOver ? 'âš ï¸ Ã–verskriden' : `${((1 - pct/100) * 100).toFixed(0)}% kvar`}</span>
                <span className={`budget-remaining ${isDanger || isOver ? 'danger' : ''}`}>
                    {isOver ? `-${Math.abs(remaining).toFixed(0)} kr` : `${remaining.toFixed(0)} kr kvar`}
                </span>
            </div>
        </div>
    );
}

// â”€â”€ SIGHTMAP â€” kartan per besÃ¶ksmÃ¥l med klickbart overlay â”€
function SightMap({ query }) {
    const [expanded, setExpanded] = useState(false);
    const embedUrl = `https://maps.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
    const directUrl = `https://www.google.com/maps/search/${encodeURIComponent(query)}`;

    return (
        <div style={{borderTop:'1px solid var(--border)'}}>
            {!expanded ? (
                // Collapsed: clickable thumbnail that opens expanded or Maps
                <div
                    style={{position:'relative', cursor:'pointer'}}
                    onClick={() => setExpanded(true)}
                >
                    <iframe
                        src={embedUrl}
                        style={{width:'100%', height:'160px', display:'block', border:'none', pointerEvents:'none'}}
                        loading="lazy"
                        referrerPolicy="no-referrer-when-downgrade"
                        title={`Karta: ${query}`}
                    />
                    {/* Overlay with instructions */}
                    <div style={{
                        position:'absolute', inset:0,
                        background:'rgba(0,0,0,0.28)',
                        display:'flex', alignItems:'center', justifyContent:'center', gap:'0.75rem',
                        flexWrap:'wrap', padding:'0.5rem'
                    }}>
                        <div style={{
                            background:'white', borderRadius:'8px', padding:'0.4rem 0.9rem',
                            fontSize:'0.82rem', fontWeight:700, color:'var(--primary)',
                            display:'flex', alignItems:'center', gap:'0.3rem', boxShadow:'0 2px 8px rgba(0,0,0,0.2)'
                        }}>
                            ğŸ” FÃ¶rstora karta
                        </div>
                        <a
                            href={directUrl}
                            target="_blank"
                            rel="noreferrer"
                            onClick={e => e.stopPropagation()}
                            style={{
                                background:'var(--primary)', borderRadius:'8px', padding:'0.4rem 0.9rem',
                                fontSize:'0.82rem', fontWeight:700, color:'white', textDecoration:'none',
                                display:'flex', alignItems:'center', gap:'0.3rem', boxShadow:'0 2px 8px rgba(0,0,0,0.2)'
                            }}
                        >
                            ğŸ—º Ã–ppna i Google Maps
                        </a>
                    </div>
                </div>
            ) : (
                // Expanded: full interactive map
                <div style={{position:'relative'}}>
                    <iframe
                        src={embedUrl}
                        style={{width:'100%', height:'300px', display:'block', border:'none'}}
                        allowFullScreen=""
                        loading="lazy"
                        referrerPolicy="no-referrer-when-downgrade"
                        title={`Karta: ${query}`}
                    />
                    <div style={{
                        position:'absolute', bottom:'8px', left:'8px', right:'8px',
                        display:'flex', gap:'0.5rem', justifyContent:'flex-end'
                    }}>
                        <button
                            onClick={() => setExpanded(false)}
                            style={{
                                background:'white', border:'1.5px solid var(--border)', borderRadius:'6px',
                                padding:'0.3rem 0.7rem', fontSize:'0.78rem', fontWeight:600, cursor:'pointer',
                                boxShadow:'0 1px 4px rgba(0,0,0,0.1)'
                            }}
                        >
                            â–² Minimera
                        </button>
                        <a
                            href={directUrl}
                            target="_blank"
                            rel="noreferrer"
                            style={{
                                background:'var(--primary)', border:'none', borderRadius:'6px',
                                padding:'0.3rem 0.7rem', fontSize:'0.78rem', fontWeight:600, cursor:'pointer',
                                color:'white', textDecoration:'none', boxShadow:'0 1px 4px rgba(0,0,0,0.1)'
                            }}
                        >
                            ğŸ—º Google Maps
                        </a>
                    </div>
                </div>
            )}
        </div>
    );
}

// â”€â”€ BESÃ–KSMÃ…L-PANEL (pÃ¥gÃ¥ende resa, redigerbar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SightsPanel({ trip, onClose, onUpdateTrip }) {
    const [activeDest, setActiveDest] = useState(0);
    const [saving, setSaving] = useState(false);
    const [saved, setSaved] = useState(false);

    const [destinations, setDestinations] = useState(() => {
        try {
            const parsed = JSON.parse(trip.plan_data || '[]');
            return parsed.length > 0 ? parsed : [makeDestination()];
        } catch { return [makeDestination()]; }
    });

    const dest = destinations[Math.min(activeDest, destinations.length - 1)];

    const updateDest = (field, val) =>
        setDestinations(ds => ds.map((d, i) => i === activeDest ? { ...d, [field]: val } : d));

    const updateSight = (sIdx, field, val) =>
        setDestinations(ds => ds.map((d, i) => i !== activeDest ? d : {
            ...d, sights: d.sights.map((s, j) => j === sIdx ? { ...s, [field]: val } : s)
        }));

    const addDest = () => {
        const nd = makeDestination();
        setDestinations(ds => [...ds, nd]);
        setActiveDest(destinations.length);
    };

    const removeDest = (idx) => {
        setDestinations(ds => ds.filter((_, i) => i !== idx));
        setActiveDest(a => Math.min(a, destinations.length - 2));
    };

    const addSight = () =>
        setDestinations(ds => ds.map((d, i) => i !== activeDest ? d : { ...d, sights: [...(d.sights || []), makeSight()] }));

    const removeSight = (sIdx) =>
        setDestinations(ds => ds.map((d, i) => i !== activeDest ? d : { ...d, sights: d.sights.filter((_, j) => j !== sIdx) }));

    const handleSave = async () => {
        setSaving(true);
        await onUpdateTrip(trip.id, { plan_data: JSON.stringify(destinations) });
        setSaving(false);
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
    };

    const mapEmbedUrl = (q) => q ? `https://maps.google.com/maps?q=${encodeURIComponent(q)}&output=embed` : null;
    const mapDirectUrl = (q) => `https://www.google.com/maps/search/${encodeURIComponent(q)}`;

    return (
        <div className="planning-panel-overlay" onClick={onClose}>
            <div className="planning-panel" onClick={e => e.stopPropagation()}>
                {/* HEADER */}
                <div className="planning-panel-header">
                    <div style={{display:'flex', alignItems:'center', gap:'0.6rem', flex:1, minWidth:0}}>
                        <span style={{fontSize:'1.3rem'}}>ğŸ“</span>
                        <span style={{fontFamily:'Space Mono, monospace', fontWeight:700, fontSize:'1.05rem', color:'white'}}>
                            {trip.name} â€” BesÃ¶ksmÃ¥l
                        </span>
                    </div>
                    <button className="close-btn" style={{color:'white', background:'rgba(255,255,255,0.15)'}} onClick={onClose}>Ã—</button>
                </div>

                <div className="planning-panel-body">

                    {/* DESTINATION TABS + ADD */}
                    <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap', alignItems:'center'}}>
                        {destinations.map((d, i) => (
                            <div key={d.id || i} style={{display:'flex', alignItems:'center', gap:'0.2rem'}}>
                                <button
                                    onClick={() => setActiveDest(i)}
                                    style={{
                                        padding:'0.4rem 0.9rem', borderRadius:'20px', border:'2px solid var(--primary)',
                                        fontFamily:'Inter, sans-serif', fontSize:'0.88rem', fontWeight:600, cursor:'pointer',
                                        background: i === activeDest ? 'var(--primary)' : 'white',
                                        color: i === activeDest ? 'white' : 'var(--primary)',
                                        transition:'all 0.15s'
                                    }}
                                >
                                    {d.name || `Destination ${i+1}`}
                                </button>
                                {destinations.length > 1 && (
                                    <button onClick={() => removeDest(i)} style={{background:'none', border:'none', cursor:'pointer', color:'var(--text-muted)', fontSize:'0.8rem', padding:'0.2rem', lineHeight:1}} title="Ta bort destination">âœ•</button>
                                )}
                            </div>
                        ))}
                        <button className="add-link" onClick={addDest} style={{fontSize:'0.85rem'}}>+ Ny destination</button>
                    </div>

                    {/* DESTINATION FIELDS */}
                    <div style={{display:'flex', flexDirection:'column', gap:'1.25rem'}}>

                        {/* DEST NAME + DATES */}
                        <div style={{background:'var(--bg)', borderRadius:'10px', padding:'1rem', display:'flex', flexDirection:'column', gap:'0.75rem'}}>
                            <div>
                                <div className="form-label" style={{marginBottom:'0.35rem'}}>Destinationsnamn</div>
                                <input
                                    className="form-input"
                                    placeholder="t.ex. Bangkok, Chiang Mai..."
                                    value={dest.name || ''}
                                    onChange={e => updateDest('name', e.target.value)}
                                />
                            </div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.75rem'}}>
                                <div>
                                    <div className="date-label" style={{marginBottom:'0.35rem'}}>ğŸ“… Ankomst</div>
                                    <input type="date" className="form-input" value={dest.dateFrom || ''} onChange={e => updateDest('dateFrom', e.target.value)} />
                                </div>
                                <div>
                                    <div className="date-label" style={{marginBottom:'0.35rem'}}>âœˆï¸ Avresa</div>
                                    <input type="date" className="form-input" value={dest.dateTo || ''} onChange={e => updateDest('dateTo', e.target.value)} min={dest.dateFrom || ''} />
                                </div>
                            </div>
                            {dest.dateFrom && dest.dateTo && new Date(dest.dateTo) > new Date(dest.dateFrom) && (
                                <div style={{fontSize:'0.82rem', color:'var(--text-muted)', fontWeight:600}}>
                                    {Math.round((new Date(dest.dateTo) - new Date(dest.dateFrom)) / 86400000)} nÃ¤tter
                                </div>
                            )}
                        </div>

                        {/* KARTA */}
                        <div>
                            <span className="section-label">ğŸ—º Karta</span>
                            <div className="map-input-row">
                                <input
                                    placeholder={dest.name ? `t.ex. ${dest.name} centrum` : 'SÃ¶k plats...'}
                                    value={dest.mapQuery || ''}
                                    onChange={e => updateDest('mapQuery', e.target.value)}
                                />
                                {!dest.mapQuery && dest.name && (
                                    <button className="btn btn-secondary btn-small" onClick={() => updateDest('mapQuery', dest.name)}>AnvÃ¤nd namn</button>
                                )}
                            </div>
                            {dest.mapQuery && (
                                <div className="map-iframe-wrap">
                                    <iframe src={mapEmbedUrl(dest.mapQuery)} allowFullScreen="" loading="lazy" referrerPolicy="no-referrer-when-downgrade" title={`Karta: ${dest.mapQuery}`} />
                                    <a className="map-open-btn" href={mapDirectUrl(dest.mapQuery)} target="_blank" rel="noreferrer">ğŸ—º Ã–ppna i Google Maps</a>
                                </div>
                            )}
                        </div>

                        {/* BESÃ–KSMÃ…L */}
                        <div>
                            <span className="section-label">ğŸ“ BesÃ¶ksmÃ¥l</span>
                            <div className="sights-list">
                                {(dest.sights || []).map((sight, sIdx) => (
                                    <div key={sight.id || sIdx} style={{background:'white', border:'1.5px solid var(--border)', borderRadius:'10px', overflow:'hidden'}}>
                                        <div style={{padding:'0.9rem 1rem', display:'flex', flexDirection:'column', gap:'0.6rem'}}>
                                            {/* NAME ROW */}
                                            <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                                <span style={{fontSize:'1rem'}}>ğŸ“</span>
                                                <input
                                                    className="sight-name-input"
                                                    placeholder="Namn pÃ¥ besÃ¶ksmÃ¥l..."
                                                    value={sight.name}
                                                    onChange={e => updateSight(sIdx, 'name', e.target.value)}
                                                />
                                                <button className="sight-del-btn" onClick={() => removeSight(sIdx)} title="Ta bort">âœ•</button>
                                            </div>
                                            {/* LINK ROW */}
                                            <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                                <span style={{fontSize:'0.8rem', color:'var(--text-muted)'}}>ğŸ”—</span>
                                                <input
                                                    className="sight-link-input"
                                                    placeholder="LÃ¤nk (TripAdvisor, hemsida...)"
                                                    value={sight.link || ''}
                                                    onChange={e => updateSight(sIdx, 'link', e.target.value)}
                                                />
                                                {sight.link && (
                                                    <a href={sight.link.startsWith('http') ? sight.link : 'https://'+sight.link} target="_blank" rel="noreferrer" className="sight-open-btn">â†—</a>
                                                )}
                                            </div>
                                            {/* MAP ROW */}
                                            <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                                <span style={{fontSize:'0.8rem', color:'var(--text-muted)'}}>ğŸ—º</span>
                                                <input
                                                    className="sight-link-input"
                                                    placeholder="KartsÃ¶kning (t.ex. Eiffeltornet, Paris)"
                                                    value={sight.mapQuery || ''}
                                                    onChange={e => updateSight(sIdx, 'mapQuery', e.target.value)}
                                                />
                                                {!sight.mapQuery && sight.name && (
                                                    <button className="sight-open-btn" style={{fontSize:'0.7rem', fontWeight:600, color:'var(--primary)', border:'1px solid var(--primary-light)', borderRadius:'4px', padding:'0.15rem 0.4rem', background:'none', cursor:'pointer', whiteSpace:'nowrap'}} onClick={() => updateSight(sIdx, 'mapQuery', sight.name)}>AnvÃ¤nd namn</button>
                                                )}
                                            </div>
                                            {/* NOTE */}
                                            <textarea
                                                className="sight-note-input"
                                                placeholder="Anteckning (Ã¶ppettider, tips, bokningsnummer...)"
                                                value={sight.note || ''}
                                                onChange={e => updateSight(sIdx, 'note', e.target.value)}
                                            />
                                        </div>
                                        {sight.mapQuery && <SightMap query={sight.mapQuery} />}
                                        {/* READ-ONLY SIGHT LINK */}
                                        {sight.name && !sight.mapQuery && sight.link && (
                                            <div style={{padding:'0 1rem 0.75rem'}}>
                                                <a href={sight.link.startsWith('http') ? sight.link : 'https://'+sight.link} target="_blank" rel="noreferrer"
                                                    style={{display:'inline-flex', alignItems:'center', gap:'0.3rem', background:'var(--primary)', color:'white', textDecoration:'none', padding:'0.3rem 0.75rem', borderRadius:'6px', fontSize:'0.8rem', fontWeight:600}}>
                                                    â†— Ã–ppna lÃ¤nk
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                <button className="add-link" onClick={addSight}>+ LÃ¤gg till besÃ¶ksmÃ¥l</button>
                            </div>
                        </div>
                    </div>
                </div>

                {/* SAVE BAR */}
                <div className="panel-save-bar">
                    <button className="btn btn-secondary" onClick={onClose}>StÃ¤ng</button>
                    <button className="btn btn-primary" onClick={handleSave} disabled={saving}>
                        {saved ? 'âœ“ Sparat!' : saving ? 'Sparar...' : 'ğŸ’¾ Spara Ã¤ndringar'}
                    </button>
                </div>
            </div>
        </div>
    );
}

// â”€â”€ TRIP IMAGE + FLAG UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FLAG_MAP = {
    // LÃ¤nder â†’ flaggemoji
    'thailand':'ğŸ‡¹ğŸ‡­','japan':'ğŸ‡¯ğŸ‡µ','japan':'ğŸ‡¯ğŸ‡µ','usa':'ğŸ‡ºğŸ‡¸','usa':'ğŸ‡ºğŸ‡¸',
    'italien':'ğŸ‡®ğŸ‡¹','italy':'ğŸ‡®ğŸ‡¹','frankrike':'ğŸ‡«ğŸ‡·','france':'ğŸ‡«ğŸ‡·',
    'spanien':'ğŸ‡ªğŸ‡¸','spain':'ğŸ‡ªğŸ‡¸','portugal':'ğŸ‡µğŸ‡¹','grekland':'ğŸ‡¬ğŸ‡·','greece':'ğŸ‡¬ğŸ‡·',
    'turkiet':'ğŸ‡¹ğŸ‡·','turkey':'ğŸ‡¹ğŸ‡·','england':'ğŸ‡¬ğŸ‡§','london':'ğŸ‡¬ğŸ‡§','uk':'ğŸ‡¬ğŸ‡§',
    'norge':'ğŸ‡³ğŸ‡´','norway':'ğŸ‡³ğŸ‡´','danmark':'ğŸ‡©ğŸ‡°','denmark':'ğŸ‡©ğŸ‡°','finland':'ğŸ‡«ğŸ‡®',
    'island':'ğŸ‡®ğŸ‡¸','iceland':'ğŸ‡®ğŸ‡¸','kroatien':'ğŸ‡­ğŸ‡·','croatia':'ğŸ‡­ğŸ‡·',
    'vietnam':'ğŸ‡»ğŸ‡³','bali':'ğŸ‡®ğŸ‡©','indonesien':'ğŸ‡®ğŸ‡©','indonesia':'ğŸ‡®ğŸ‡©',
    'indien':'ğŸ‡®ğŸ‡³','india':'ğŸ‡®ğŸ‡³','marocko':'ğŸ‡²ğŸ‡¦','morocco':'ğŸ‡²ğŸ‡¦',
    'mexiko':'ğŸ‡²ğŸ‡½','mexico':'ğŸ‡²ğŸ‡½','new york':'ğŸ‡ºğŸ‡¸','paris':'ğŸ‡«ğŸ‡·',
    'barcelona':'ğŸ‡ªğŸ‡¸','rom':'ğŸ‡®ğŸ‡¹','rome':'ğŸ‡®ğŸ‡¹','amsterdam':'ğŸ‡³ğŸ‡±',
    'berlin':'ğŸ‡©ğŸ‡ª','tyskland':'ğŸ‡©ğŸ‡ª','germany':'ğŸ‡©ğŸ‡ª','Ã¶sterrike':'ğŸ‡¦ğŸ‡¹','austria':'ğŸ‡¦ğŸ‡¹',
    'schweiz':'ğŸ‡¨ğŸ‡­','switzerland':'ğŸ‡¨ğŸ‡­','dubai':'ğŸ‡¦ğŸ‡ª','singapore':'ğŸ‡¸ğŸ‡¬',
    'kanada':'ğŸ‡¨ğŸ‡¦','canada':'ğŸ‡¨ğŸ‡¦','australien':'ğŸ‡¦ğŸ‡º','australia':'ğŸ‡¦ğŸ‡º',
    'new zealand':'ğŸ‡³ğŸ‡¿','sydafrika':'ğŸ‡¿ğŸ‡¦','kenya':'ğŸ‡°ğŸ‡ª','egypten':'ğŸ‡ªğŸ‡¬','egypt':'ğŸ‡ªğŸ‡¬',
    'kuba':'ğŸ‡¨ğŸ‡º','cuba':'ğŸ‡¨ğŸ‡º','brasilien':'ğŸ‡§ğŸ‡·','brazil':'ğŸ‡§ğŸ‡·',
    'peru':'ğŸ‡µğŸ‡ª','argentina':'ğŸ‡¦ğŸ‡·','colombia':'ğŸ‡¨ğŸ‡´','chile':'ğŸ‡¨ğŸ‡±',
    'sri lanka':'ğŸ‡±ğŸ‡°','nepal':'ğŸ‡³ğŸ‡µ','cambodja':'ğŸ‡°ğŸ‡­','cambodia':'ğŸ‡°ğŸ‡­',
    'laos':'ğŸ‡±ğŸ‡¦','myanmar':'ğŸ‡²ğŸ‡²','filippinerna':'ğŸ‡µğŸ‡­','philippines':'ğŸ‡µğŸ‡­',
    'malaysia':'ğŸ‡²ğŸ‡¾','taiwan':'ğŸ‡¹ğŸ‡¼','sydkorea':'ğŸ‡°ğŸ‡·','korea':'ğŸ‡°ğŸ‡·',
    'kina':'ğŸ‡¨ğŸ‡³','china':'ğŸ‡¨ğŸ‡³','hong kong':'ğŸ‡­ğŸ‡°','maldiverna':'ğŸ‡²ğŸ‡»','maldives':'ğŸ‡²ğŸ‡»',
    'zanzibar':'ğŸ‡¹ğŸ‡¿','tanzania':'ğŸ‡¹ğŸ‡¿','island':'ğŸ‡®ğŸ‡¸'
};

function getTripFlag(tripName) {
    if (!tripName) return 'ğŸŒ';
    const lower = tripName.toLowerCase();
    for (const [key, flag] of Object.entries(FLAG_MAP)) {
        if (lower.includes(key)) return flag;
    }
    return 'ğŸŒ';
}

const PEXELS_KEY = 'VVd5ZKQX6htphwA9rMZPMV1kRO2cyIOabmLmc8ytfUO40YGzSLXoa6qL';

function useTripImage(tripName) {
    const [imgUrl, setImgUrl] = React.useState(null);
    React.useEffect(() => {
        if (!tripName) return;
        const query = tripName.replace(/\b20\d\d\b/g, '').trim().split(/\s+/).slice(0,3).join(' ');
        if (!query) return;
        fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query + ' travel')}&per_page=1&orientation=landscape`, {
            headers: { Authorization: PEXELS_KEY }
        })
        .then(r => r.json())
        .then(data => {
            if (data.photos && data.photos.length > 0) {
                setImgUrl(data.photos[0].src.large);
            } else {
                // Fallback: Picsum med seed frÃ¥n resnamnet fÃ¶r konsekvent bild
                const seed = tripName.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
                setImgUrl(`https://picsum.photos/seed/${seed}/600/400`);
            }
        })
        .catch(() => {
            const seed = tripName.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            setImgUrl(`https://picsum.photos/seed/${seed}/600/400`);
        });
    }, [tripName]);
    return imgUrl;
}

// Shared image+flag shell used by all three views
function TripCardShell({ trip, badge, selected, onClick, children }) {
    const imgUrl = useTripImage(trip.name);
    const flag = getTripFlag(trip.name);
    return (
        <div
            className={`trip-card ${selected ? 'selected' : ''}`}
            onClick={onClick}
        >
            {/* Background image or gradient */}
            {imgUrl
                ? <div className="tc-img" style={{backgroundImage:`url(${imgUrl})`}} />
                : <div className="tc-img-placeholder" />
            }
            <div className="tc-overlay" />
            <div className="tc-content">
                <div className="tc-top">
                    <span className="tc-flag">{flag}</span>
                    {badge && <span className={`tc-badge ${badge.cls}`}>{badge.label}</span>}
                </div>
                {children}
            </div>
        </div>
    );
}

// â”€â”€ RESAKORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TripCards({ trips, selectedTrip, onSelectTrip, allExpenses, onAddTrip, onDeleteTrip, onCompleteTrip, onUnplanTrip, onNewPlannedTrip, onUpdateTrip }) {
    const [sightsPanelTrip, setSightsPanelTrip] = useState(null);
    const [renamingTrip, setRenamingTrip] = useState(null);  // trip id being renamed
    const [renameValue, setRenameValue] = useState('');
    const [notesTrip, setNotesTrip] = useState(null);        // trip id with notes open
    const [notesValue, setNotesValue] = useState('');

    const handleRenameStart = (trip, e) => {
        e.stopPropagation();
        setRenamingTrip(trip.id);
        setRenameValue(trip.name);
    };
    const handleRenameSave = async (tripId, e) => {
        e && e.stopPropagation();
        if (renameValue.trim()) await onUpdateTrip(tripId, { name: renameValue.trim() });
        setRenamingTrip(null);
    };
    const handleNotesOpen = (trip, e) => {
        e.stopPropagation();
        setNotesTrip(trip.id);
        setNotesValue(trip.notes || '');
    };
    const handleNotesSave = async (tripId, e) => {
        e && e.stopPropagation();
        await onUpdateTrip(tripId, { notes: notesValue });
        setNotesTrip(null);
    };

    const getTripTotal = (tripId) => {
        return allExpenses
            .filter(e => e.trip_id === tripId)
            .reduce((sum, e) => sum + e.amount * e.exchange_rate, 0);
    };

    const getTripIcons = ['âœˆï¸','ğŸŒ','ğŸï¸','ğŸ—ºï¸','ğŸš€','â›µ','ğŸ”ï¸','ğŸ’'];
    const getTripIcon = (tripId) => {
        const idx = parseInt(String(tripId).replace(/\D/g, '').slice(-1)) % getTripIcons.length;
        return getTripIcons[idx] || 'âœˆï¸';
    };

    const hasPlanData = (trip) => {
        try {
            const d = JSON.parse(trip.plan_data || '[]');
            return d.some(dest => dest.name || dest.mapQuery || (dest.sights && dest.sights.some(s => s.name)));
        } catch { return false; }
    };

    // Only show active (non-completed) trips
    const activeTrips = trips.filter(t => !t.is_completed);

    return (
        <div>
            {sightsPanelTrip && (
                <SightsPanel trip={sightsPanelTrip} onClose={() => setSightsPanelTrip(null)} onUpdateTrip={onUpdateTrip} />
            )}

            {/* VIKTIGA ANTECKNINGAR MODAL */}
            {notesTrip && (() => {
                const trip = trips.find(t => t.id === notesTrip);
                return (
                    <div className="modal-overlay" onClick={() => setNotesTrip(null)}>
                        <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth:'500px'}}>
                            <div className="modal-header">
                                <span className="modal-title">ğŸ“‹ Viktiga anteckningar â€” {trip?.name}</span>
                                <button className="close-btn" onClick={() => setNotesTrip(null)}>Ã—</button>
                            </div>
                            <p style={{fontSize:'0.85rem', color:'var(--text-muted)', marginBottom:'0.75rem'}}>
                                Pass, bokningsnummer, vaccinationer, viktiga kontakter...
                            </p>
                            <textarea
                                className="form-input"
                                rows="10"
                                placeholder={"ğŸ›‚ Pass gÃ¤ller till: ...\nâœˆï¸ Bokningsnr: ...\nğŸ¨ Hotelladress: ...\nğŸ’Š Medicin: ...\nğŸ“ NÃ¶dkontakt: ..."}
                                style={{resize:'vertical', fontFamily:'Inter, sans-serif', fontSize:'0.92rem', lineHeight:1.7}}
                                value={notesValue}
                                onChange={e => setNotesValue(e.target.value)}
                                autoFocus
                            />
                            <div style={{display:'flex', gap:'0.75rem', marginTop:'1rem'}}>
                                <button className="btn btn-secondary" style={{flex:1}} onClick={() => setNotesTrip(null)}>Avbryt</button>
                                <button className="btn btn-primary" style={{flex:1}} onClick={e => handleNotesSave(notesTrip, e)}>ğŸ’¾ Spara</button>
                            </div>
                        </div>
                    </div>
                );
            })()}

            <div className="trip-cards-grid">
                {activeTrips.map(trip => {
                    const count = allExpenses.filter(e => e.trip_id === trip.id).length;
                    const total = getTripTotal(trip.id);
                    const hasBudget = trip.budget && trip.budget > 0;
                    const hasPlanned = hasPlanData(trip);
                    const hasNotes = trip.notes && trip.notes.trim().length > 0;
                    return (
                        <TripCardShell
                            key={trip.id}
                            trip={trip}
                            badge={{ label:'âœˆ PÃ¥gÃ¥ende', cls:'tc-badge-active' }}
                            selected={selectedTrip === trip.id}
                            onClick={() => onSelectTrip(selectedTrip === trip.id ? null : trip.id)}
                        >
                            <div className="tc-bottom">
                                {/* Inline rename or name display */}
                                {renamingTrip === trip.id ? (
                                    <div style={{display:'flex', gap:'0.35rem', marginBottom:'0.3rem'}} onClick={e => e.stopPropagation()}>
                                        <input
                                            className="form-input"
                                            value={renameValue}
                                            onChange={e => setRenameValue(e.target.value)}
                                            onKeyDown={e => { if (e.key === 'Enter') handleRenameSave(trip.id); if (e.key === 'Escape') setRenamingTrip(null); }}
                                            style={{flex:1, padding:'0.4rem 0.6rem', fontSize:'0.9rem', background:'rgba(255,255,255,0.9)', color:'var(--text)', borderRadius:'6px', border:'none'}}
                                            autoFocus
                                        />
                                        <button style={{background:'rgba(47,111,78,0.85)', border:'none', borderRadius:'6px', color:'white', cursor:'pointer', padding:'0.3rem 0.6rem', fontSize:'0.85rem'}} onClick={e => handleRenameSave(trip.id, e)}>âœ“</button>
                                        <button style={{background:'rgba(255,255,255,0.2)', border:'none', borderRadius:'6px', color:'white', cursor:'pointer', padding:'0.3rem 0.6rem', fontSize:'0.85rem'}} onClick={e => { e.stopPropagation(); setRenamingTrip(null); }}>âœ•</button>
                                    </div>
                                ) : (
                                    <div style={{display:'flex', alignItems:'center', gap:'0.4rem', marginBottom:'0.1rem'}}>
                                        <div className="tc-name" style={{marginBottom:0, flex:1}}>{trip.name}</div>
                                        <button
                                            style={{background:'rgba(255,255,255,0.15)', border:'none', borderRadius:'5px', color:'rgba(255,255,255,0.8)', cursor:'pointer', padding:'0.2rem 0.4rem', fontSize:'0.75rem', flexShrink:0, lineHeight:1}}
                                            onClick={e => handleRenameStart(trip, e)}
                                            title="Byt namn"
                                        >âœï¸</button>
                                    </div>
                                )}
                                <div className="tc-meta">
                                    {count} {count === 1 ? 'utgift' : 'utgifter'}
                                    {hasBudget ? ` Â· Budget: ${Number(trip.budget).toFixed(0)} kr` : ''}
                                    {hasNotes && ' Â· ğŸ“‹'}
                                </div>
                                {hasBudget && (() => {
                                    const pct = Math.min(100, (total / trip.budget) * 100);
                                    const color = pct > 90 ? '#f44336' : pct > 70 ? '#ff9800' : '#4caf50';
                                    return (
                                        <div className="tc-budget-bar">
                                            <div className="tc-budget-fill" style={{width:`${pct}%`, background:color}} />
                                        </div>
                                    );
                                })()}
                                <div className="tc-total">{total > 0 ? `${total.toFixed(0)} kr` : 'â€“'}</div>
                                <div className="tc-actions" onClick={e => e.stopPropagation()}>
                                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.35rem'}}>
                                        <button className="btn btn-secondary btn-small" style={{justifyContent:'center', fontSize:'0.82rem'}} onClick={() => setSightsPanelTrip(trip)}>ğŸ“ BesÃ¶ksmÃ¥l</button>
                                        <button
                                            className="btn btn-secondary btn-small"
                                            style={{justifyContent:'center', fontSize:'0.82rem'}}
                                            onClick={e => handleNotesOpen(trip, e)}
                                        >{hasNotes ? 'ğŸ“‹ Anteckningar â—' : 'ğŸ“‹ Anteckningar'}</button>
                                    </div>
                                    <button
                                        className="btn btn-primary btn-small"
                                        style={{width:'100%', justifyContent:'center', fontSize:'0.85rem'}}
                                        onClick={() => onCompleteTrip(trip.id, trip.name)}
                                    >âœ… Avsluta resa</button>
                                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.35rem'}}>
                                        <button className="btn btn-secondary btn-small" style={{justifyContent:'center', fontSize:'0.82rem'}} onClick={() => onUnplanTrip(trip.id, trip.name)}>â†© Planerade</button>
                                        <button className="btn btn-danger btn-small" style={{justifyContent:'center', fontSize:'0.82rem'}} onClick={() => onDeleteTrip(trip.id, trip.name)}>ğŸ—‘ Ta bort</button>
                                    </div>
                                </div>
                            </div>
                        </TripCardShell>
                    );
                })}

                {/* Ny resa-kort */}
                <div className="trip-card trip-card-new" onClick={onNewPlannedTrip}>
                    <span className="plus-icon">+</span>
                    <span>Ny resa</span>
                </div>
            </div>
        </div>
    );
}

// â”€â”€ DAGÃ–VERSIKT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DayBreakdown({ expenses, categories, users }) {
    const getCatInfo = (id) => categories.find(c => c.id === id) || { icon: 'ğŸ“Œ', name: id };
    const getUserName = (uid) => users.find(u => u.id === uid)?.name || 'OkÃ¤nd';

    const grouped = expenses.reduce((acc, e) => {
        const day = new Date(e.date).toLocaleDateString('sv-SE');
        if (!acc[day]) acc[day] = [];
        acc[day].push(e);
        return acc;
    }, {});

    const sortedDays = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

    if (sortedDays.length === 0) {
        return <p style={{textAlign:'center', color:'var(--text-muted)', padding:'2rem'}}>Inga utgifter att visa</p>;
    }

    return (
        <div className="day-breakdown">
            {sortedDays.map(day => {
                const dayExpenses = grouped[day];
                const dayTotal = dayExpenses.reduce((s, e) => s + e.amount * e.exchange_rate, 0);
                return (
                    <div key={day} className="day-group">
                        <div className="day-group-header">
                            <span>{day}</span>
                            <span className="day-group-total">{dayTotal.toFixed(0)} kr</span>
                        </div>
                        <div className="day-group-items">
                            {dayExpenses.map(expense => {
                                const cat = getCatInfo(expense.category);
                                return (
                                    <div key={expense.id} className="expense-item">
                                        <div className="expense-category">{cat.icon}</div>
                                        <div className="expense-details">
                                            <div className="expense-description">{expense.description}</div>
                                            <div className="expense-meta">
                                                {cat.name} Â· {getUserName(expense.added_by)}
                                            </div>
                                        </div>
                                        <div className="expense-amount">
                                            <div className="expense-price">{(expense.amount * expense.exchange_rate).toFixed(0)} kr</div>
                                            <div className="expense-currency">({expense.amount.toFixed(0)} {expense.currency})</div>
                                        </div>
                                        <div style={{width:'32px'}}></div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })}
        </div>
    );
}

// â”€â”€ HUVUDAPP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
    const [currentUser, setCurrentUser] = useState(null);
    const [users, setUsers] = useState([]);
    const [trips, setTrips] = useState([]);
    const [expenses, setExpenses] = useState([]);
    const [activeTab, setActiveTab] = useState('expenses');
    const [selectedTrip, setSelectedTrip] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
    const [showAdmin, setShowAdmin] = useState(false);
    const [autoEditTrip, setAutoEditTrip] = useState(null);

    useEffect(() => {
        if (currentUser) {
            loadData();
            try {
                const saved = localStorage.getItem('varraresor_cats_' + currentUser.id);
                if (saved) setCategories(JSON.parse(saved));
            } catch(e) {}
        }
    }, [currentUser]);

    const saveCategories = (cats) => {
        setCategories(cats);
        try { localStorage.setItem('varraresor_cats_' + currentUser.id, JSON.stringify(cats)); } catch(e) {}
    };

    const loadData = async () => {
        try {
            setLoading(true);
            const [{ data: usersData }, { data: tripsData }, { data: expensesData }] = await Promise.all([
                supabase.from('users').select('*'),
                supabase.from('trips').select('*').order('created_at', { ascending: false }),
                supabase.from('expenses').select('*').order('date', { ascending: false })
            ]);
            setUsers(usersData || []);
            setTrips(tripsData || []);
            setExpenses(expensesData || []);
            setLoading(false);
        } catch (err) {
            setError('Kunde inte ladda data: ' + err.message);
            setLoading(false);
        }
    };

    const handleAddTrip = async (trip) => {
        const { data, error } = await supabase.from('trips').insert([{ ...trip, created_by: currentUser.id }]).select();
        if (!error && data) {
            setTrips([data[0], ...trips]);
            if (!trip.is_planned) setSelectedTrip(data[0].id);
            return data[0];
        }
        return null;
    };

    const handleActivateTrip = async (id) => {
        const { error } = await supabase.from('trips').update({ is_planned: false }).eq('id', id);
        if (!error) {
            setTrips(trips.map(t => t.id === id ? { ...t, is_planned: false } : t));
            setSelectedTrip(id);
            setActiveTab('expenses');
        }
    };

    const handleUpdateTrip = async (id, updates) => {
        const { error } = await supabase.from('trips').update(updates).eq('id', id);
        if (!error) setTrips(trips.map(t => t.id === id ? { ...t, ...updates } : t));
    };

    const handleCompleteTrip = async (id) => {
        const { error } = await supabase.from('trips').update({ is_completed: true }).eq('id', id);
        if (!error) {
            setTrips(trips.map(t => t.id === id ? { ...t, is_completed: true } : t));
            if (selectedTrip === id) setSelectedTrip(null);
        }
    };

    const handleUnplanTrip = async (id) => {
        const { error } = await supabase.from('trips').update({ is_planned: true }).eq('id', id);
        if (!error) {
            setTrips(trips.map(t => t.id === id ? { ...t, is_planned: true } : t));
            if (selectedTrip === id) setSelectedTrip(null);
            setActiveTab('planned');
        }
    };

    const handleDeleteTrip = async (id) => {
        await supabase.from('expenses').delete().eq('trip_id', id);
        const { error } = await supabase.from('trips').delete().eq('id', id);
        if (!error) {
            setTrips(trips.filter(t => t.id !== id));
            setExpenses(expenses.filter(e => e.trip_id !== id));
            if (selectedTrip === id) setSelectedTrip(null);
        }
    };

    const handleAddExpense = async (expense) => {
        const { data, error } = await supabase.from('expenses').insert([{ ...expense, trip_id: selectedTrip, added_by: currentUser.id }]).select();
        if (!error && data) setExpenses([data[0], ...expenses]);
    };

    const handleNewPlannedTrip = async () => {
        const newTrip = await handleAddTrip({
            name: 'Ny resa',
            budget: null,
            plan_data: JSON.stringify([makeDestination()]),
            is_planned: true,
            is_completed: false,
            created_at: new Date().toISOString()
        });
        if (newTrip) {
            setActiveTab('planned');
            setAutoEditTrip(newTrip);
        }
    };

    const handleDeleteExpense = async (id) => {
        const { error } = await supabase.from('expenses').delete().eq('id', id);
        if (!error) setExpenses(expenses.filter(e => e.id !== id));
    };

    const handleUpdateExpense = async (id, updates) => {
        const { error } = await supabase.from('expenses').update(updates).eq('id', id);
        if (!error) setExpenses(expenses.map(e => e.id === id ? { ...e, ...updates } : e));
    };

    if (!currentUser) return <LoginForm onLogin={setCurrentUser} />;
    if (loading) return <div className="loading"><div className="spinner"/><p>Laddar data...</p></div>;

    return (
        <div className="app-container">
            <Header
                user={currentUser}
                onLogout={() => setCurrentUser(null)}
                onAdminClick={() => setShowAdmin(true)}
            />
            <div className="header-spacer" />
            {error && <div className="alert alert-error">{error}</div>}

            {showAdmin && currentUser.is_admin && (
                <div className="modal-overlay" onClick={() => setShowAdmin(false)}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth:'700px'}}>
                        <div className="modal-header">
                            <span className="modal-title">âš™ï¸ Admin</span>
                            <button className="close-btn" onClick={() => setShowAdmin(false)}>Ã—</button>
                        </div>
                        <AdminView
                            users={users}
                            onAddUser={async (user) => {
                                const { data, error } = await supabase.from('users').insert([user]).select();
                                if (!error && data) setUsers([...users, data[0]]);
                            }}
                            onDeleteUser={async (id) => {
                                const { error } = await supabase.from('users').delete().eq('id', id);
                                if (!error) setUsers(users.filter(u => u.id !== id));
                            }}
                            onResetPassword={async (id, newPassword) => {
                                const { error } = await supabase.from('users').update({ password: newPassword }).eq('id', id);
                                if (!error) setUsers(users.map(u => u.id === id ? { ...u, password: newPassword } : u));
                            }}
                            onToggleAdmin={async (id, isAdmin) => {
                                const { error } = await supabase.from('users').update({ is_admin: isAdmin }).eq('id', id);
                                if (!error) setUsers(users.map(u => u.id === id ? { ...u, is_admin: isAdmin } : u));
                            }}
                        />
                    </div>
                </div>
            )}

            <div className="main-content">
                <div className="tabs">
                    <button className={`tab ${activeTab==='planned'?'active':''}`} onClick={() => setActiveTab('planned')}>ğŸ—“ Planerade Resor</button>
                    <button className={`tab ${activeTab==='expenses'?'active':''}`} onClick={() => setActiveTab('expenses')}>ğŸ’¸ PÃ¥gÃ¥ende Resa</button>
                    <button className={`tab ${activeTab==='history'?'active':''}`} onClick={() => setActiveTab('history')}>ğŸ“‚ Avslutade Resor</button>
                </div>

                {activeTab === 'planned' && (
                    <PlannedTripsView
                        trips={trips.filter(t => t.is_planned && !t.is_completed)}
                        onAddTrip={handleAddTrip}
                        onDeleteTrip={handleDeleteTrip}
                        onActivateTrip={handleActivateTrip}
                        onUpdateTrip={handleUpdateTrip}
                        autoEditTrip={autoEditTrip}
                        onClearAutoEdit={() => setAutoEditTrip(null)}
                    />
                )}

                {activeTab === 'expenses' && (
                    <ExpensesView
                        trips={trips.filter(t => !t.is_planned && !t.is_completed)}
                        selectedTrip={selectedTrip}
                        onSelectTrip={setSelectedTrip}
                        expenses={expenses.filter(e => !selectedTrip || e.trip_id === selectedTrip)}
                        allExpenses={expenses}
                        users={users}
                        currentUser={currentUser}
                        categories={categories}
                        onAddCategory={cat => saveCategories([...categories, cat])}
                        onDeleteCategory={id => saveCategories(categories.filter(c => c.id !== id))}
                        onAddTrip={handleAddTrip}
                        onDeleteTrip={handleDeleteTrip}
                        onCompleteTrip={handleCompleteTrip}
                        onUnplanTrip={handleUnplanTrip}
                        onAddExpense={handleAddExpense}
                        onDeleteExpense={handleDeleteExpense}
                        onUpdateExpense={handleUpdateExpense}
                        onNewPlannedTrip={handleNewPlannedTrip}
                        onUpdateTrip={handleUpdateTrip}
                    />
                )}

                {activeTab === 'history' && (
                    <CompletedTripsView
                        trips={trips.filter(t => t.is_completed)}
                        allExpenses={expenses}
                        users={users}
                        currentUser={currentUser}
                        categories={categories}
                        onDeleteTrip={handleDeleteTrip}
                        onAddExpense={async (expense, tripId) => {
                            const { data, error } = await supabase.from('expenses').insert([{ ...expense, trip_id: tripId, added_by: currentUser.id }]).select();
                            if (!error && data) setExpenses([data[0], ...expenses]);
                        }}
                        onDeleteExpense={handleDeleteExpense}
                    />
                )}
            </div>
        </div>
    );
}

// â”€â”€ RESA SAMMANFATTNING MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TripSummaryModal({ trip, expenses, categories, users, onClose }) {
    const total = expenses.reduce((s, e) => s + e.amount * e.exchange_rate, 0);
    const hasBudget = trip.budget && trip.budget > 0;
    const diff = hasBudget ? trip.budget - total : null;
    const underBudget = diff !== null && diff >= 0;

    const catTotals = categories.map(cat => ({
        ...cat,
        total: expenses.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount * e.exchange_rate, 0),
        count: expenses.filter(e => e.category === cat.id).length
    })).filter(c => c.total > 0).sort((a, b) => b.total - a.total);

    const top5 = [...expenses].sort((a, b) => (b.amount * b.exchange_rate) - (a.amount * a.exchange_rate)).slice(0, 5);

    const getUserName = (uid) => users.find(u => u.id === uid)?.name || 'OkÃ¤nd';

    const days = (() => {
        if (!trip.start_date || !trip.end_date) return null;
        return Math.max(1, Math.ceil((new Date(trip.end_date) - new Date(trip.start_date)) / 86400000));
    })();

    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth:'600px', maxHeight:'90vh', overflowY:'auto'}}>
                {/* Header with trip image tint */}
                <div style={{
                    background: `linear-gradient(135deg, var(--primary) 0%, #1a3a2a 100%)`,
                    borderRadius:'12px', padding:'1.5rem', marginBottom:'1.5rem', color:'white', position:'relative', overflow:'hidden'
                }}>
                    <div style={{fontSize:'2.5rem', marginBottom:'0.4rem'}}>{getTripFlag(trip.name)}</div>
                    <h2 style={{fontWeight:800, fontSize:'1.4rem', marginBottom:'0.25rem'}}>{trip.name}</h2>
                    <div style={{fontSize:'0.85rem', opacity:0.8}}>
                        {expenses.length} utgifter
                        {days && ` Â· ${days} dagar`}
                        {trip.start_date && ` Â· ${new Date(trip.start_date).toLocaleDateString('sv-SE')}`}
                        {trip.end_date && ` â€“ ${new Date(trip.end_date).toLocaleDateString('sv-SE')}`}
                    </div>
                    <div style={{marginTop:'1rem', display:'flex', gap:'1.5rem', flexWrap:'wrap'}}>
                        <div>
                            <div style={{fontFamily:'Space Mono, monospace', fontSize:'1.8rem', fontWeight:700}}>{total.toFixed(0)} kr</div>
                            <div style={{fontSize:'0.75rem', opacity:0.75}}>TOTALT SPENDERAT</div>
                        </div>
                        {hasBudget && (
                            <div>
                                <div style={{fontFamily:'Space Mono, monospace', fontSize:'1.8rem', fontWeight:700, color: underBudget ? '#a5d6a7' : '#ef9a9a'}}>
                                    {underBudget ? '+' : ''}{diff.toFixed(0)} kr
                                </div>
                                <div style={{fontSize:'0.75rem', opacity:0.75}}>{underBudget ? 'UNDER BUDGET' : 'Ã–VER BUDGET'}</div>
                            </div>
                        )}
                        {days && expenses.length > 0 && (
                            <div>
                                <div style={{fontFamily:'Space Mono, monospace', fontSize:'1.8rem', fontWeight:700}}>{(total / days).toFixed(0)} kr</div>
                                <div style={{fontSize:'0.75rem', opacity:0.75}}>PER DAG</div>
                            </div>
                        )}
                    </div>
                    {hasBudget && (
                        <div style={{marginTop:'1rem'}}>
                            <div style={{height:'6px', background:'rgba(255,255,255,0.2)', borderRadius:'3px', overflow:'hidden'}}>
                                <div style={{
                                    height:'100%', borderRadius:'3px',
                                    width:`${Math.min(100, (total / trip.budget) * 100)}%`,
                                    background: underBudget ? '#4caf50' : '#f44336',
                                    transition:'width 0.8s ease'
                                }} />
                            </div>
                            <div style={{display:'flex', justifyContent:'space-between', fontSize:'0.72rem', opacity:0.7, marginTop:'0.3rem'}}>
                                <span>0 kr</span><span>Budget: {Number(trip.budget).toFixed(0)} kr</span>
                            </div>
                        </div>
                    )}
                </div>

                {/* Per kategori */}
                {catTotals.length > 0 && (
                    <div style={{marginBottom:'1.5rem'}}>
                        <h3 style={{fontWeight:700, fontSize:'1rem', color:'var(--primary)', marginBottom:'0.75rem'}}>ğŸ“Š Per kategori</h3>
                        <div style={{display:'flex', flexDirection:'column', gap:'0.5rem'}}>
                            {catTotals.map(cat => {
                                const pct = total > 0 ? (cat.total / total) * 100 : 0;
                                return (
                                    <div key={cat.id} style={{display:'flex', alignItems:'center', gap:'0.75rem'}}>
                                        <span style={{width:'28px', textAlign:'center', fontSize:'1.1rem'}}>{cat.icon}</span>
                                        <div style={{flex:1}}>
                                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'0.2rem'}}>
                                                <span style={{fontSize:'0.88rem', fontWeight:500}}>{cat.name}</span>
                                                <span style={{fontFamily:'Space Mono, monospace', fontSize:'0.85rem', fontWeight:700}}>{cat.total.toFixed(0)} kr</span>
                                            </div>
                                            <div style={{height:'4px', background:'var(--border)', borderRadius:'2px', overflow:'hidden'}}>
                                                <div style={{height:'100%', width:`${pct}%`, background:'var(--primary)', borderRadius:'2px'}} />
                                            </div>
                                            <div style={{fontSize:'0.72rem', color:'var(--text-muted)', marginTop:'0.15rem'}}>{pct.toFixed(0)}% Â· {cat.count} utgifter</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}

                {/* Top 5 */}
                {top5.length > 0 && (
                    <div style={{marginBottom:'1.5rem'}}>
                        <h3 style={{fontWeight:700, fontSize:'1rem', color:'var(--primary)', marginBottom:'0.75rem'}}>ğŸ’¸ StÃ¶rsta utgifterna</h3>
                        <div style={{display:'flex', flexDirection:'column', gap:'0.4rem'}}>
                            {top5.map((e, i) => {
                                const cat = categories.find(c => c.id === e.category) || { icon:'ğŸ“Œ' };
                                return (
                                    <div key={e.id} style={{display:'flex', alignItems:'center', gap:'0.75rem', padding:'0.6rem 0.75rem', background:'var(--bg)', borderRadius:'8px'}}>
                                        <span style={{fontFamily:'Space Mono, monospace', fontSize:'0.75rem', color:'var(--text-muted)', width:'18px'}}>{i+1}.</span>
                                        <span style={{fontSize:'1rem'}}>{cat.icon}</span>
                                        <span style={{flex:1, fontSize:'0.88rem', fontWeight:500}}>{e.description}</span>
                                        <span style={{fontFamily:'Space Mono, monospace', fontWeight:700, fontSize:'0.88rem'}}>{(e.amount * e.exchange_rate).toFixed(0)} kr</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}

                <div style={{display:'flex', gap:'0.75rem'}}>
                    <button className="btn btn-secondary" style={{flex:1}} onClick={onClose}>StÃ¤ng</button>
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => { onClose(); setTimeout(() => window.dispatchEvent(new CustomEvent('openExport', { detail: { trip, expenses, categories, users } })), 100); }}>
                        ğŸ“¤ Exportera
                    </button>
                </div>
            </div>
        </div>
    );
}

// â”€â”€ EXPORT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TripExportModal({ trip, expenses, categories, users, onClose }) {
    const getUserName = (uid) => users.find(u => u.id === uid)?.name || 'OkÃ¤nd';
    const total = expenses.reduce((s, e) => s + e.amount * e.exchange_rate, 0);
    const catTotals = categories.map(cat => ({
        ...cat,
        total: expenses.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount * e.exchange_rate, 0)
    })).filter(c => c.total > 0).sort((a, b) => b.total - a.total);

    const exportCSV = () => {
        const rows = [
            ['Datum','Beskrivning','Kategori','Belopp (original)','Valuta','Belopp (SEK)','Tillagd av','Anteckning'],
            ...expenses.map(e => {
                const cat = categories.find(c => c.id === e.category)?.name || e.category;
                return [
                    new Date(e.date).toLocaleDateString('sv-SE'),
                    e.description,
                    cat,
                    e.amount.toFixed(2),
                    e.currency,
                    (e.amount * e.exchange_rate).toFixed(2),
                    getUserName(e.added_by),
                    e.note || ''
                ];
            })
        ];
        const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${trip.name.replace(/\s+/g,'-')}-utgifter.csv`; a.click();
        URL.revokeObjectURL(url);
    };

    const exportPDF = () => {
        const printWin = window.open('', '_blank');
        const flag = getTripFlag(trip.name);
        const totalSEK = expenses.reduce((s, e) => s + e.amount * e.exchange_rate, 0);
        const hasBudget = trip.budget && trip.budget > 0;
        const underBudget = hasBudget && totalSEK <= trip.budget;

        const catRows = catTotals.map(cat => `
            <tr>
                <td>${cat.icon} ${cat.name}</td>
                <td style="text-align:right;font-family:monospace;font-weight:700">${cat.total.toFixed(0)} kr</td>
                <td style="text-align:right;color:#666">${totalSEK > 0 ? ((cat.total/totalSEK)*100).toFixed(0) : 0}%</td>
            </tr>`).join('');

        const expRows = expenses.map((e, i) => {
            const cat = categories.find(c => c.id === e.category) || { icon:'ğŸ“Œ', name: e.category };
            return `<tr style="background:${i%2===0?'#f9fdf9':'white'}">
                <td style="color:#666">${new Date(e.date).toLocaleDateString('sv-SE')}</td>
                <td><strong>${e.description}</strong>${e.note ? `<br><small style="color:#888">${e.note}</small>` : ''}</td>
                <td>${cat.icon} ${cat.name}</td>
                <td style="text-align:right;color:#666">${e.amount.toFixed(0)} ${e.currency}</td>
                <td style="text-align:right;font-family:monospace;font-weight:700">${(e.amount*e.exchange_rate).toFixed(0)} kr</td>
            </tr>`;
        }).join('');

        printWin.document.write(`<!DOCTYPE html><html><head>
            <meta charset="UTF-8">
            <title>${trip.name} â€“ Utgiftsrapport</title>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
            <style>
                * { margin:0; padding:0; box-sizing:border-box; }
                body { font-family:'Inter',sans-serif; background:white; color:#1F2D26; padding:40px; max-width:800px; margin:0 auto; }
                .cover { background:linear-gradient(135deg,#2F6F4E,#1a3a2a); color:white; border-radius:16px; padding:2rem; margin-bottom:2rem; }
                .cover h1 { font-size:2rem; font-weight:800; margin-bottom:0.25rem; }
                .cover .meta { font-size:0.85rem; opacity:0.75; margin-bottom:1.25rem; }
                .stats { display:flex; gap:2rem; flex-wrap:wrap; }
                .stat { }
                .stat-val { font-family:monospace; font-size:1.6rem; font-weight:700; }
                .stat-label { font-size:0.7rem; opacity:0.7; text-transform:uppercase; letter-spacing:.05em; }
                .section { margin-bottom:2rem; }
                .section h2 { font-size:1rem; font-weight:700; color:#2F6F4E; border-bottom:2px solid #E6F2EC; padding-bottom:0.5rem; margin-bottom:1rem; }
                table { width:100%; border-collapse:collapse; font-size:0.88rem; }
                th { background:#2F6F4E; color:white; padding:0.6rem 0.75rem; text-align:left; font-weight:600; }
                td { padding:0.55rem 0.75rem; border-bottom:1px solid #E6F2EC; vertical-align:top; }
                .budget-bar { height:8px; background:#E6F2EC; border-radius:4px; margin-top:1rem; overflow:hidden; }
                .budget-fill { height:100%; border-radius:4px; background:${underBudget?'#4caf50':'#f44336'}; width:${Math.min(100,(totalSEK/(trip.budget||1))*100).toFixed(0)}%; }
                .footer { margin-top:3rem; padding-top:1rem; border-top:1px solid #C8DDD3; text-align:center; font-size:0.75rem; color:#888; }
                @media print { body { padding:20px; } .no-print { display:none; } }
            </style>
        </head><body>
            <div class="cover">
                <div style="font-size:2.5rem;margin-bottom:0.5rem">${flag}</div>
                <h1>${trip.name}</h1>
                <div class="meta">
                    ${expenses.length} utgifter
                    ${trip.start_date ? ' Â· ' + new Date(trip.start_date).toLocaleDateString('sv-SE') : ''}
                    ${trip.end_date ? ' â€“ ' + new Date(trip.end_date).toLocaleDateString('sv-SE') : ''}
                    Â· Exporterad ${new Date().toLocaleDateString('sv-SE')}
                </div>
                <div class="stats">
                    <div class="stat"><div class="stat-val">${totalSEK.toFixed(0)} kr</div><div class="stat-label">Totalt spenderat</div></div>
                    ${hasBudget ? `<div class="stat"><div class="stat-val" style="color:${underBudget?'#a5d6a7':'#ef9a9a'}">${(trip.budget - totalSEK).toFixed(0)} kr</div><div class="stat-label">${underBudget?'Under budget':'Ã–ver budget'}</div></div>` : ''}
                </div>
                ${hasBudget ? `<div class="budget-bar"><div class="budget-fill"></div></div>` : ''}
            </div>

            <div class="section">
                <h2>Per kategori</h2>
                <table><thead><tr><th>Kategori</th><th style="text-align:right">Belopp</th><th style="text-align:right">Andel</th></tr></thead>
                <tbody>${catRows}</tbody></table>
            </div>

            <div class="section">
                <h2>Alla utgifter</h2>
                <table><thead><tr><th>Datum</th><th>Beskrivning</th><th>Kategori</th><th style="text-align:right">Original</th><th style="text-align:right">SEK</th></tr></thead>
                <tbody>${expRows}</tbody>
                <tfoot><tr style="background:#2F6F4E;color:white"><td colspan="4" style="font-weight:700;padding:0.6rem 0.75rem">TOTALT</td><td style="text-align:right;font-family:monospace;font-weight:700;padding:0.6rem 0.75rem">${totalSEK.toFixed(0)} kr</td></tr></tfoot>
                </table>
            </div>

            <div class="footer">VÃ¥ra resor Â· Exporterad ${new Date().toLocaleString('sv-SE')}</div>

            <script>setTimeout(() => { window.print(); }, 400);<\/script>
        </body></html>`);
        printWin.document.close();
    };

    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth:'420px'}}>
                <div className="modal-header">
                    <span className="modal-title">ğŸ“¤ Exportera â€” {trip.name}</span>
                    <button className="close-btn" onClick={onClose}>Ã—</button>
                </div>
                <p style={{fontSize:'0.88rem', color:'var(--text-muted)', marginBottom:'1.25rem'}}>
                    {expenses.length} utgifter Â· {expenses.reduce((s,e) => s + e.amount * e.exchange_rate, 0).toFixed(0)} kr totalt
                </p>
                <div style={{display:'flex', flexDirection:'column', gap:'0.75rem'}}>
                    <button className="btn btn-primary" style={{justifyContent:'center', fontSize:'1rem', padding:'0.9rem'}} onClick={exportPDF}>
                        ğŸ–¨ï¸ Exportera som PDF
                        <span style={{fontSize:'0.75rem', opacity:0.75, fontWeight:400, marginLeft:'0.3rem'}}>â€” snygg rapport som Ã¶ppnas i nytt fÃ¶nster</span>
                    </button>
                    <button className="btn btn-secondary" style={{justifyContent:'center', fontSize:'1rem', padding:'0.9rem'}} onClick={exportCSV}>
                        ğŸ“Š Ladda ner CSV
                        <span style={{fontSize:'0.75rem', opacity:0.75, fontWeight:400, marginLeft:'0.3rem'}}>â€” Ã¶ppna i Excel eller Google Sheets</span>
                    </button>
                </div>
                <button className="btn btn-secondary" style={{width:'100%', justifyContent:'center', marginTop:'1rem'}} onClick={onClose}>Avbryt</button>
            </div>
        </div>
    );
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeDestination() {
    return { id: Date.now() + Math.random(), name: '', dateFrom: '', dateTo: '', mapQuery: '', sights: [] };
}
function makeSight() {
    return { id: Date.now() + Math.random(), name: '', link: '', mapQuery: '', note: '' };
}

// Converts a Google Maps search query to an embed URL
function mapEmbedUrl(query) {
    if (!query.trim()) return null;
    return `https://maps.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
}
function mapDirectUrl(query) {
    return `https://www.google.com/maps/search/${encodeURIComponent(query)}`;
}

// â”€â”€ RESAPLANERARE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TripPlannerPanel({ trip, onSave, onClose, onActivate, onDelete }) {
    const [name, setName] = useState(trip.name || '');
    const [budget, setBudget] = useState(trip.budget ? String(trip.budget) : '');
    const [destinations, setDestinations] = useState(() => {
        try { return trip.plan_data ? JSON.parse(trip.plan_data) : [makeDestination()]; } catch { return [makeDestination()]; }
    });
    const [saving, setSaving] = useState(false);
    const [confirm, setConfirm] = useState(null);

    const updateDest = (idx, field, val) => {
        setDestinations(ds => ds.map((d, i) => i === idx ? { ...d, [field]: val } : d));
    };
    const updateSight = (dIdx, sIdx, field, val) => {
        setDestinations(ds => ds.map((d, i) => i !== dIdx ? d : {
            ...d, sights: d.sights.map((s, j) => j === sIdx ? { ...s, [field]: val } : s)
        }));
    };
    const addDest = () => setDestinations(ds => [...ds, makeDestination()]);
    const removeDest = (idx) => setDestinations(ds => ds.filter((_, i) => i !== idx));
    const addSight = (dIdx) => setDestinations(ds => ds.map((d, i) => i !== dIdx ? d : { ...d, sights: [...d.sights, makeSight()] }));
    const removeSight = (dIdx, sIdx) => setDestinations(ds => ds.map((d, i) => i !== dIdx ? d : { ...d, sights: d.sights.filter((_, j) => j !== sIdx) }));

    const handleSave = async () => {
        setSaving(true);
        await onSave(trip.id, {
            name: name.trim() || trip.name,
            budget: budget ? parseFloat(budget) : null,
            plan_data: JSON.stringify(destinations)
        });
        setSaving(false);
    };

    return (
        <div className="planning-panel-overlay" onClick={onClose}>
            {confirm && (
                <ConfirmDialog
                    title="Ta bort planerad resa?"
                    message={`"${trip.name}" raderas permanent.`}
                    onConfirm={() => { onDelete(trip.id); onClose(); setConfirm(null); }}
                    onCancel={() => setConfirm(null)}
                />
            )}
            <div className="planning-panel" onClick={e => e.stopPropagation()}>
                {/* HEADER */}
                <div className="planning-panel-header">
                    <div style={{display:'flex', alignItems:'center', gap:'0.6rem', flex:1, minWidth:0}}>
                        <span style={{fontSize:'1.3rem'}}>ğŸ—“</span>
                        <input
                            className="editable-title-input"
                            value={name}
                            onChange={e => setName(e.target.value)}
                            placeholder="Resans namn..."
                        />
                    </div>
                    <div style={{display:'flex', alignItems:'center', gap:'0.75rem', flexShrink:0}}>
                        <div className="budget-inline-row">
                            <span>Budget:</span>
                            <input
                                className="budget-inline-input"
                                type="number" min="0" step="1"
                                placeholder="kr"
                                value={budget}
                                onChange={e => setBudget(e.target.value)}
                            />
                            <span>kr</span>
                        </div>
                        <button className="close-btn" style={{color:'white', background:'rgba(255,255,255,0.15)'}} onClick={onClose}>Ã—</button>
                    </div>
                </div>

                {/* BODY */}
                <div className="planning-panel-body">
                    {/* ACTION BUTTONS */}
                    <div style={{display:'flex', gap:'0.75rem', flexWrap:'wrap'}}>
                        <button className="btn btn-secondary btn-small" onClick={() => setConfirm(true)}>ğŸ—‘ Ta bort resa</button>
                        <button className="btn btn-primary btn-small" style={{marginLeft:'auto'}} onClick={() => { handleSave(); onActivate(trip.id); onClose(); }}>â–¶ Starta resa nu</button>
                    </div>

                    {/* DESTINATIONS */}
                    <div>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'0.75rem'}}>
                            <span style={{fontWeight:700, fontSize:'1rem', color:'var(--primary)'}}>Destinationer</span>
                            <button className="add-link" onClick={addDest}>+ LÃ¤gg till destination</button>
                        </div>

                        <div style={{display:'flex', flexDirection:'column', gap:'1rem'}}>
                            {destinations.map((dest, dIdx) => (
                                <div key={dest.id} className="dest-card">
                                    {/* DEST HEADER */}
                                    <div className="dest-card-header">
                                        <div className="dest-number">{dIdx + 1}</div>
                                        <input
                                            className="dest-name-input"
                                            placeholder="Stad / Destination..."
                                            value={dest.name}
                                            onChange={e => updateDest(dIdx, 'name', e.target.value)}
                                        />
                                        {destinations.length > 1 && (
                                            <button className="sight-del-btn" onClick={() => removeDest(dIdx)} title="Ta bort destination">âœ•</button>
                                        )}
                                    </div>

                                    <div className="dest-body">
                                        {/* DATES */}
                                        <div>
                                            <span className="section-label">ğŸ“… Datum</span>
                                            <div className="dates-row">
                                                <div className="date-field">
                                                    <span className="date-label">Ankomst</span>
                                                    <input type="date" className="date-input" value={dest.dateFrom} onChange={e => updateDest(dIdx, 'dateFrom', e.target.value)} />
                                                </div>
                                                <div className="date-field">
                                                    <span className="date-label">Avresa</span>
                                                    <input type="date" className="date-input" value={dest.dateTo} onChange={e => updateDest(dIdx, 'dateTo', e.target.value)} />
                                                </div>
                                                {dest.dateFrom && dest.dateTo && new Date(dest.dateTo) > new Date(dest.dateFrom) && (
                                                    <div style={{fontSize:'0.8rem', color:'var(--text-muted)', alignSelf:'flex-end', paddingBottom:'0.5rem', whiteSpace:'nowrap'}}>
                                                        {Math.round((new Date(dest.dateTo) - new Date(dest.dateFrom)) / 86400000)} nÃ¤tter
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* MAP */}
                                        <div>
                                            <span className="section-label">ğŸ—º Karta</span>
                                            <div className="map-input-row">
                                                <input
                                                    placeholder={dest.name ? `t.ex. ${dest.name} centrum` : 'SÃ¶k plats pÃ¥ kartan...'}
                                                    value={dest.mapQuery}
                                                    onChange={e => updateDest(dIdx, 'mapQuery', e.target.value)}
                                                />
                                                {!dest.mapQuery && dest.name && (
                                                    <button className="btn btn-secondary btn-small" style={{whiteSpace:'nowrap'}} onClick={() => updateDest(dIdx, 'mapQuery', dest.name)}>
                                                        AnvÃ¤nd destinationsnamn
                                                    </button>
                                                )}
                                            </div>
                                            {dest.mapQuery && (
                                                <div className="map-iframe-wrap">
                                                    <iframe
                                                        src={mapEmbedUrl(dest.mapQuery)}
                                                        allowFullScreen=""
                                                        loading="lazy"
                                                        referrerPolicy="no-referrer-when-downgrade"
                                                        title={`Karta: ${dest.mapQuery}`}
                                                    />
                                                    <a className="map-open-btn" href={mapDirectUrl(dest.mapQuery)} target="_blank" rel="noreferrer">
                                                        ğŸ—º Ã–ppna i Google Maps
                                                    </a>
                                                </div>
                                            )}
                                        </div>

                                        {/* SIGHTS */}
                                        <div>
                                            <span className="section-label">ğŸ“ BesÃ¶ksmÃ¥l</span>
                                            <div className="sights-list">
                                                {dest.sights.map((sight, sIdx) => (
                                                    <div key={sight.id} className="sight-item">
                                                        {/* ROW 1: Namn */}
                                                        <div className="sight-row1">
                                                            <span style={{fontSize:'1rem'}}>ğŸ“</span>
                                                            <input
                                                                className="sight-name-input"
                                                                placeholder="Namn pÃ¥ besÃ¶ksmÃ¥l..."
                                                                value={sight.name}
                                                                onChange={e => updateSight(dIdx, sIdx, 'name', e.target.value)}
                                                            />
                                                            <button className="sight-del-btn" onClick={() => removeSight(dIdx, sIdx)} title="Ta bort">âœ•</button>
                                                        </div>
                                                        {/* ROW 2: LÃ¤nk */}
                                                        <div className="sight-row2">
                                                            <span style={{fontSize:'0.8rem', color:'var(--text-muted)', flexShrink:0}}>ğŸ”—</span>
                                                            <input
                                                                className="sight-link-input"
                                                                placeholder="LÃ¤nk (TripAdvisor, hemsida...)"
                                                                value={sight.link}
                                                                onChange={e => updateSight(dIdx, sIdx, 'link', e.target.value)}
                                                            />
                                                            {sight.link && (
                                                                <a className="sight-open-btn" href={sight.link.startsWith('http') ? sight.link : 'https://'+sight.link} target="_blank" rel="noreferrer" title="Ã–ppna lÃ¤nk">â†—</a>
                                                            )}
                                                        </div>
                                                        {/* ROW 3: Karta */}
                                                        <div className="sight-row2">
                                                            <span style={{fontSize:'0.8rem', color:'var(--text-muted)', flexShrink:0}}>ğŸ—º</span>
                                                            <input
                                                                className="sight-link-input"
                                                                placeholder="KartavsÃ¶kning (t.ex. Eiffeltornet, Paris)"
                                                                value={sight.mapQuery || ''}
                                                                onChange={e => updateSight(dIdx, sIdx, 'mapQuery', e.target.value)}
                                                            />
                                                            {!sight.mapQuery && sight.name && (
                                                                <button
                                                                    className="sight-open-btn"
                                                                    style={{fontSize:'0.7rem', fontWeight:600, color:'var(--primary)', border:'1px solid var(--primary-light)', borderRadius:'4px', padding:'0.15rem 0.4rem', background:'none', cursor:'pointer', fontFamily:'Inter, sans-serif', whiteSpace:'nowrap'}}
                                                                    onClick={() => updateSight(dIdx, sIdx, 'mapQuery', sight.name)}
                                                                >AnvÃ¤nd namn</button>
                                                            )}
                                                        </div>
                                                        {/* MAP PREVIEW */}
                                                        {sight.mapQuery && (
                                                            <div className="map-iframe-wrap" style={{marginTop:'0.1rem'}}>
                                                                <iframe
                                                                    src={mapEmbedUrl(sight.mapQuery)}
                                                                    allowFullScreen="" loading="lazy"
                                                                    referrerPolicy="no-referrer-when-downgrade"
                                                                    title={`Karta: ${sight.mapQuery}`}
                                                                />
                                                                <a className="map-open-btn" href={mapDirectUrl(sight.mapQuery)} target="_blank" rel="noreferrer">
                                                                    ğŸ—º Ã–ppna i Google Maps
                                                                </a>
                                                            </div>
                                                        )}
                                                        {/* ROW 4: Anteckning */}
                                                        <textarea
                                                            className="sight-note-input"
                                                            placeholder="Anteckning (Ã¶ppettider, tips, bokningsnummer...)"
                                                            value={sight.note}
                                                            onChange={e => updateSight(dIdx, sIdx, 'note', e.target.value)}
                                                        />
                                                    </div>
                                                ))}
                                                <button className="add-link" onClick={() => addSight(dIdx)}>+ LÃ¤gg till besÃ¶ksmÃ¥l</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                {/* SAVE BAR */}
                <div className="panel-save-bar">
                    <button className="btn btn-secondary" onClick={onClose}>StÃ¤ng</button>
                    <button className="btn btn-primary" onClick={handleSave} disabled={saving}>
                        {saving ? 'Sparar...' : 'ğŸ’¾ Spara Ã¤ndringar'}
                    </button>
                </div>
            </div>
        </div>
    );
}

// â”€â”€ PLANERADE RESOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PlannedTripsView({ trips, onAddTrip, onDeleteTrip, onActivateTrip, onUpdateTrip, autoEditTrip, onClearAutoEdit }) {
    const [editingTrip, setEditingTrip] = useState(null);
    const [confirm, setConfirm] = useState(null);

    // Open planner automatically when a new trip is created from another tab
    React.useEffect(() => {
        if (autoEditTrip) {
            setEditingTrip(autoEditTrip);
            onClearAutoEdit();
        }
    }, [autoEditTrip]);

    const handleCreateTrip = async () => {
        const newTrip = await onAddTrip({
            name: 'Ny resa',
            budget: null,
            plan_data: JSON.stringify([makeDestination()]),
            is_planned: true,
            is_completed: false,
            created_at: new Date().toISOString()
        });
        if (newTrip) setEditingTrip(newTrip);
    };

    const getTripIcons = ['âœˆï¸','ğŸŒ','ğŸï¸','ğŸ—ºï¸','ğŸš€','â›µ','ğŸ”ï¸','ğŸ’'];
    const getTripIcon = (tripId) => {
        const idx = parseInt(String(tripId).replace(/\D/g, '').slice(-1)) % getTripIcons.length;
        return getTripIcons[idx] || 'âœˆï¸';
    };

    const getDestCount = (trip) => {
        try { const d = JSON.parse(trip.plan_data || '[]'); return d.filter(x => x.name).length; } catch { return 0; }
    };
    const getDateRange = (trip) => {
        try {
            const d = JSON.parse(trip.plan_data || '[]');
            const dates = d.flatMap(x => [x.dateFrom, x.dateTo]).filter(Boolean).sort();
            if (dates.length >= 2) return `${dates[0]} â†’ ${dates[dates.length-1]}`;
        } catch {}
        return null;
    };

    return (
        <div>
            {confirm && (
                <ConfirmDialog
                    title="Ta bort planerad resa?"
                    message={`"${confirm.name}" raderas permanent.`}
                    onConfirm={() => { onDeleteTrip(confirm.id); setConfirm(null); }}
                    onCancel={() => setConfirm(null)}
                />
            )}


            {editingTrip && (
                <TripPlannerPanel
                    trip={editingTrip}
                    onSave={async (id, updates) => {
                        await onUpdateTrip(id, updates);
                        setEditingTrip(t => ({ ...t, ...updates }));
                    }}
                    onClose={() => setEditingTrip(null)}
                    onActivate={(id) => { onActivateTrip(id); setEditingTrip(null); }}
                    onDelete={(id) => { onDeleteTrip(id); setEditingTrip(null); }}
                />
            )}

            <div className="trip-cards-grid">
                {trips.map(trip => {
                    const destCount = getDestCount(trip);
                    const dateRange = getDateRange(trip);
                    return (
                        <TripCardShell
                            key={trip.id}
                            trip={trip}
                            badge={{ label:'ğŸ—“ Planerad', cls:'tc-badge-planned' }}
                            selected={false}
                            onClick={null}
                        >
                            <div className="tc-bottom">
                                <div className="tc-name">{trip.name}</div>
                                <div className="tc-meta">
                                    {destCount > 0 && `${destCount} ${destCount === 1 ? 'destination' : 'destinationer'}`}
                                    {dateRange && ` Â· ğŸ“… ${dateRange}`}
                                    {trip.budget && trip.budget > 0 && ` Â· ğŸ’° ${Number(trip.budget).toFixed(0)} kr`}
                                </div>
                                <div className="tc-actions">
                                    <button className="btn btn-primary btn-small" style={{width:'100%', justifyContent:'center', fontSize:'0.85rem'}} onClick={() => onActivateTrip(trip.id)}>â–¶ Starta resa</button>
                                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.35rem'}}>
                                        <button className="btn btn-secondary btn-small" style={{justifyContent:'center', fontSize:'0.82rem'}} onClick={() => setEditingTrip(trip)}>âœï¸ Planera</button>
                                        <button className="btn btn-danger btn-small" style={{justifyContent:'center', fontSize:'0.82rem'}} onClick={() => setConfirm({ id: trip.id, name: trip.name })}>ğŸ—‘ Ta bort</button>
                                    </div>
                                </div>
                            </div>
                        </TripCardShell>
                    );
                })}

                <div className="trip-card trip-card-new" onClick={handleCreateTrip}>
                    <span className="plus-icon">+</span>
                    <span>Planera resa</span>
                </div>
            </div>

            {trips.length === 0 && (
                <div className="placeholder-box" style={{marginTop:'0'}}>
                    <div className="placeholder-icon">ğŸ—“ï¸</div>
                    <div className="placeholder-title">Inga planerade resor</div>
                    <div className="placeholder-desc">Klicka pÃ¥ "Planera resa" fÃ¶r att lÃ¤gga till en kommande resa med destinationer, datum och besÃ¶ksmÃ¥l.</div>
                </div>
            )}
        </div>
    );
}

// â”€â”€ AVSLUTADE RESOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CompletedTripsView({ trips, allExpenses, users, currentUser, categories, onDeleteTrip, onAddExpense, onDeleteExpense }) {
    const [confirm, setConfirm] = useState(null);
    const [expandedTrip, setExpandedTrip] = useState(null);
    const [expenseView, setExpenseView] = useState('list');
    const [summaryTrip, setSummaryTrip] = useState(null);
    const [exportTrip, setExportTrip] = useState(null);

    // Listen for export events from TripSummaryModal
    React.useEffect(() => {
        const handler = (e) => setExportTrip(e.detail);
        window.addEventListener('openExport', handler);
        return () => window.removeEventListener('openExport', handler);
    }, []);

    // Add-expense form state per expanded trip
    const [description, setDescription] = useState('');
    const [amount, setAmount] = useState('');
    const [currency, setCurrency] = useState('SEK');
    const [category, setCategory] = useState('food');
    const [expenseDate, setExpenseDate] = useState(new Date().toISOString().split('T')[0]);
    const [submitting, setSubmitting] = useState(false);

    const getCatInfo = (id) => categories.find(c => c.id === id) || { icon: 'ğŸ“Œ', name: id };
    const getUserName = (uid) => users.find(u => u.id === uid)?.name || 'OkÃ¤nd';

    const getTripTotal = (tripId) =>
        allExpenses.filter(e => e.trip_id === tripId).reduce((sum, e) => sum + e.amount * e.exchange_rate, 0);

    const getTripIcons = ['âœˆï¸','ğŸŒ','ğŸï¸','ğŸ—ºï¸','ğŸš€','â›µ','ğŸ”ï¸','ğŸ’'];
    const getTripIcon = (tripId) => {
        const idx = parseInt(String(tripId).replace(/\D/g, '').slice(-1)) % getTripIcons.length;
        return getTripIcons[idx] || 'âœˆï¸';
    };

    const handleAddExpense = async (e, tripId) => {
        e.preventDefault();
        if (!description || !amount || submitting) return;
        setSubmitting(true);
        const sel = CURRENCIES.find(c => c.code === currency);
        await onAddExpense({ description, amount: parseFloat(amount), currency, exchange_rate: sel.rate, category, date: new Date(expenseDate).toISOString() }, tripId);
        setDescription(''); setAmount(''); setCategory('food');
        setExpenseDate(new Date().toISOString().split('T')[0]);
        setSubmitting(false);
    };

    if (trips.length === 0) {
        return (
            <div className="placeholder-box">
                <div className="placeholder-icon">ğŸ“‚</div>
                <div className="placeholder-title">Inga avslutade resor</div>
                <div className="placeholder-desc">Resor du avslutar frÃ¥n PÃ¥gÃ¥ende Resa-fliken dyker upp hÃ¤r.</div>
            </div>
        );
    }

    return (
        <div>
            {confirm && (
                <ConfirmDialog
                    title={confirm.type === 'trip' ? 'Ta bort avslutad resa?' : 'Ta bort utgift?'}
                    message={confirm.type === 'trip'
                        ? `"${confirm.name}" och alla dess utgifter raderas permanent.`
                        : `"${confirm.name}" raderas permanent.`}
                    onConfirm={() => {
                        if (confirm.type === 'trip') onDeleteTrip(confirm.id);
                        else onDeleteExpense(confirm.id);
                        setConfirm(null);
                    }}
                    onCancel={() => setConfirm(null)}
                />
            )}

            {summaryTrip && (
                <TripSummaryModal
                    trip={summaryTrip}
                    expenses={allExpenses.filter(e => e.trip_id === summaryTrip.id)}
                    categories={categories}
                    users={users}
                    onClose={() => setSummaryTrip(null)}
                />
            )}

            {exportTrip && (
                <TripExportModal
                    trip={exportTrip.trip}
                    expenses={exportTrip.expenses}
                    categories={exportTrip.categories}
                    users={exportTrip.users}
                    onClose={() => setExportTrip(null)}
                />
            )}

            <div className="trip-cards-grid" style={{marginBottom:'2rem'}}>
                {trips.map(trip => {
                    const count = allExpenses.filter(e => e.trip_id === trip.id).length;
                    const total = getTripTotal(trip.id);
                    const hasBudget = trip.budget && trip.budget > 0;
                    const underBudget = hasBudget && total <= trip.budget;
                    return (
                        <TripCardShell
                            key={trip.id}
                            trip={trip}
                            badge={{ label:'âœ“ Avslutad', cls:'tc-badge-done' }}
                            selected={false}
                            onClick={null}
                        >
                            <div className="tc-bottom">
                                <div className="tc-name">{trip.name}</div>
                                <div className="tc-meta">
                                    {count} {count === 1 ? 'utgift' : 'utgifter'}
                                    {hasBudget ? ` Â· Budget: ${trip.budget.toFixed(0)} kr` : ''}
                                </div>
                                {hasBudget && (() => {
                                    const pct = Math.min(100, (total / trip.budget) * 100);
                                    const color = pct > 100 ? '#f44336' : '#4caf50';
                                    return (
                                        <div className="tc-budget-bar">
                                            <div className="tc-budget-fill" style={{width:`${Math.min(100,pct)}%`, background:color}} />
                                        </div>
                                    );
                                })()}
                                {hasBudget && (
                                    <div style={{fontSize:'0.75rem', color: underBudget ? '#a5d6a7' : '#ef9a9a', fontWeight:600, marginBottom:'0.4rem'}}>
                                        {underBudget ? `âœ“ Sparade ${(trip.budget - total).toFixed(0)} kr` : `âš  Ã–verskred med ${(total - trip.budget).toFixed(0)} kr`}
                                    </div>
                                )}
                                <div className="tc-total">{total > 0 ? `${total.toFixed(0)} kr` : 'â€“'}</div>
                                <div className="tc-actions">
                                    <button
                                        className="btn btn-primary btn-small"
                                        style={{width:'100%', justifyContent:'center', fontSize:'0.82rem'}}
                                        onClick={() => setSummaryTrip(trip)}
                                    >ğŸ“Š Sammanfattning</button>
                                    <div style={{display:'flex', gap:'0.35rem'}}>
                                        <button
                                            className="btn btn-secondary btn-small"
                                            style={{flex:1, justifyContent:'center', fontSize:'0.78rem'}}
                                            onClick={() => { setExpandedTrip(expandedTrip === trip.id ? null : trip.id); setExpenseView('list'); }}
                                        >{expandedTrip === trip.id ? 'â–² DÃ¶lj' : 'ğŸ“‹ Visa utgifter'}</button>
                                        <button className="trip-card-del" onClick={() => setConfirm({ type:'trip', id: trip.id, name: trip.name })}>ğŸ—‘</button>
                                    </div>
                                </div>
                            </div>
                        </TripCardShell>
                    );
                })}
            </div>

            {/* EXPANDED EXPENSE PANEL */}
            {expandedTrip && (() => {
                const trip = trips.find(t => t.id === expandedTrip);
                if (!trip) return null;
                const tripExpenses = allExpenses.filter(e => e.trip_id === expandedTrip).sort((a,b) => new Date(b.date) - new Date(a.date));

                return (
                    <div className="card" style={{marginBottom:'2rem'}}>
                        <div className="card-header">
                            <h3 className="card-title">{trip.name} â€” utgifter</h3>
                            <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                <button className="btn btn-secondary btn-small" style={{fontSize:'0.8rem'}} onClick={() => setExportTrip({ trip, expenses: tripExpenses, categories, users })}>ğŸ“¤ Exportera</button>
                                <div className="view-toggle">
                                    <span className="view-toggle-label">Visa:</span>
                                    <button className={`toggle-btn ${expenseView==='list'?'active':''}`} onClick={() => setExpenseView('list')}>Lista</button>
                                    <button className={`toggle-btn ${expenseView==='day'?'active':''}`} onClick={() => setExpenseView('day')}>Per dag</button>
                                </div>
                            </div>
                        </div>

                        {/* LÃ¤gg till utgift */}
                        <form onSubmit={e => handleAddExpense(e, expandedTrip)} style={{background:'var(--primary)', borderRadius:'10px', padding:'1.25rem', marginBottom:'1.5rem', color:'white'}}>
                            <div style={{fontWeight:600, marginBottom:'0.75rem', fontSize:'0.95rem'}}>âš¡ LÃ¤gg till utgift</div>
                            <div style={{display:'grid', gridTemplateColumns:'2fr 1fr 1fr 1fr 1fr auto', gap:'0.75rem', alignItems:'end'}}>
                                <input type="text" className="form-input" placeholder="Vad?" value={description} onChange={e => setDescription(e.target.value)} required disabled={submitting} style={{background:'rgba(255,255,255,0.95)'}} />
                                <input type="number" step="0.01" className="form-input" placeholder="Belopp" value={amount} onChange={e => setAmount(e.target.value)} required disabled={submitting} style={{background:'rgba(255,255,255,0.95)'}} />
                                <select className="form-select" value={currency} onChange={e => setCurrency(e.target.value)} disabled={submitting} style={{background:'rgba(255,255,255,0.95)'}}>
                                    {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code}</option>)}
                                </select>
                                <select className="form-select" value={category} onChange={e => setCategory(e.target.value)} disabled={submitting} style={{background:'rgba(255,255,255,0.95)'}}>
                                    {categories.map(c => <option key={c.id} value={c.id}>{c.icon} {c.name}</option>)}
                                </select>
                                <input type="date" className="form-input" value={expenseDate} onChange={e => setExpenseDate(e.target.value)} disabled={submitting} required style={{background:'rgba(255,255,255,0.95)'}} />
                                <button type="submit" className="btn btn-secondary" disabled={submitting}>{submitting ? '...' : 'LÃ¤gg till'}</button>
                            </div>
                        </form>

                        {/* Expense list or day view */}
                        {tripExpenses.length === 0 ? (
                            <p style={{textAlign:'center', color:'var(--text-muted)', padding:'2rem'}}>Inga utgifter fÃ¶r denna resa</p>
                        ) : expenseView === 'list' ? (
                            <div className="expense-list">
                                {tripExpenses.map(expense => {
                                    const cat = getCatInfo(expense.category);
                                    return (
                                        <div key={expense.id} className="expense-item">
                                            <div className="expense-category">{cat.icon}</div>
                                            <div className="expense-details">
                                                <div className="expense-description">{expense.description}</div>
                                                <div className="expense-meta">{cat.name} Â· {getUserName(expense.added_by)} Â· {new Date(expense.date).toLocaleDateString('sv-SE')}</div>
                                            </div>
                                            <div className="expense-amount">
                                                <div className="expense-price">{(expense.amount * expense.exchange_rate).toFixed(0)} kr</div>
                                                <div className="expense-currency">({expense.amount.toFixed(0)} {expense.currency})</div>
                                            </div>
                                            <button className="btn btn-danger btn-icon btn-small" title="Ta bort utgift"
                                                onClick={() => setConfirm({ type:'expense', id: expense.id, name: expense.description })}
                                            >ğŸ—‘</button>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <DayBreakdown expenses={tripExpenses} categories={categories} users={users} />
                        )}
                    </div>
                );
            })()}
        </div>
    );
}

// â”€â”€ INLOGGNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginForm({ onLogin }) {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true); setError('');
        try {
            const { data, error } = await supabase.from('users').select('*').eq('username', username).eq('password', password).single();
            if (error || !data) setError('Fel anvÃ¤ndarnamn eller lÃ¶senord');
            else onLogin(data);
        } catch (err) { setError('Fel vid inloggning: ' + err.message); }
        setLoading(false);
    };

    return (
        <div className="login-container">
            <h1 className="login-title">âœˆï¸ VÃ¥ra resor</h1>
            {error && <div className="alert alert-error">{error}</div>}
            <form onSubmit={handleSubmit}>
                <div className="form-group">
                    <label className="form-label">AnvÃ¤ndarnamn</label>
                    <input type="text" className="form-input" value={username} onChange={e => setUsername(e.target.value)} required disabled={loading} />
                </div>
                <div className="form-group">
                    <label className="form-label">LÃ¶senord</label>
                    <input type="password" className="form-input" value={password} onChange={e => setPassword(e.target.value)} required disabled={loading} />
                </div>
                <button type="submit" className="btn btn-primary" style={{width:'100%'}} disabled={loading}>
                    {loading ? 'Loggar in...' : 'Logga in'}
                </button>
            </form>
        </div>
    );
}

// â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Header({ user, onLogout, onAdminClick }) {
    return (
        <header className="header">
            <div className="logo">âœˆï¸ VÃ¥ra resor</div>
            <div className="user-info" style={{marginTop:'0.6rem'}}>
                {user.is_admin ? (
                    <span className="user-badge admin-badge" onClick={onAdminClick} title="Ã–ppna adminpanelen">
                        {user.name} (Admin) âš™ï¸
                    </span>
                ) : (
                    <span className="user-badge">{user.name}</span>
                )}
                <button className="btn btn-secondary btn-small" onClick={onLogout}>Logga ut</button>
            </div>
        </header>
    );
}

// â”€â”€ UTGIFTSVY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ExpensesView({ trips, selectedTrip, onSelectTrip, expenses, allExpenses, users, currentUser, categories, onAddCategory, onDeleteCategory, onAddTrip, onDeleteTrip, onCompleteTrip, onUnplanTrip, onAddExpense, onDeleteExpense, onUpdateExpense, onNewPlannedTrip, onUpdateTrip }) {
    const [description, setDescription] = useState('');
    const [amount, setAmount] = useState('');
    const [currency, setCurrency] = useState('SEK');
    const [category, setCategory] = useState('food');
    const [expenseDate, setExpenseDate] = useState(new Date().toISOString().split('T')[0]);
    const [note, setNote] = useState('');
    const [submitting, setSubmitting] = useState(false);
    const [showCatManager, setShowCatManager] = useState(false);
    const [confirm, setConfirm] = useState(null);
    const [expenseView, setExpenseView] = useState('list');
    const [editingExpense, setEditingExpense] = useState(null); // expense being edited
    const [exportData, setExportData] = useState(null);

    const { getCurrencies, ratesUpdated } = useLiveRates();
    const CURRENCIES = getCurrencies();

    const handleAddExpense = async (e) => {
        e.preventDefault();
        if (!description || !amount || submitting || !selectedTrip) return;
        setSubmitting(true);
        const sel = CURRENCIES.find(c => c.code === currency);
        await onAddExpense({ description, amount: parseFloat(amount), currency, exchange_rate: sel.rate, category, date: new Date(expenseDate).toISOString(), note: note.trim() });
        setDescription(''); setAmount(''); setCategory('food'); setNote('');
        setExpenseDate(new Date().toISOString().split('T')[0]);
        setSubmitting(false);
    };

    const handleSaveEdit = async () => {
        if (!editingExpense) return;
        const sel = CURRENCIES.find(c => c.code === editingExpense.currency);
        await onUpdateExpense(editingExpense.id, {
            description: editingExpense.description,
            amount: parseFloat(editingExpense.amount),
            currency: editingExpense.currency,
            exchange_rate: sel ? sel.rate : editingExpense.exchange_rate,
            category: editingExpense.category,
            date: new Date(editingExpense.date).toISOString(),
            note: editingExpense.note || ''
        });
        setEditingExpense(null);
    };

    const handleDeleteTripConfirm = (id, name) => {
        setConfirm({ type: 'trip', id, name });
    };

    const getCatInfo = (id) => categories.find(c => c.id === id) || { icon: 'ğŸ“Œ', name: id };
    const getUserName = (uid) => users.find(u => u.id === uid)?.name || 'OkÃ¤nd';

    const totalSEK = expenses.reduce((sum, e) => sum + (e.amount * e.exchange_rate), 0);
    const categoryTotals = categories.map(cat => ({
        ...cat,
        total: expenses.filter(e => e.category === cat.id).reduce((s, e) => s + e.amount * e.exchange_rate, 0)
    })).filter(c => c.total > 0);

    // Days remaining â€” only if selected trip has BOTH start_date and end_date
    const selectedTripObj = trips.find(t => t.id === selectedTrip);
    const daysRemaining = (() => {
        if (!selectedTripObj?.start_date || !selectedTripObj?.end_date) return null;
        const today = new Date(); today.setHours(0,0,0,0);
        const end = new Date(selectedTripObj.end_date); end.setHours(0,0,0,0);
        const diff = Math.ceil((end - today) / 86400000);
        return diff;
    })();
    const totalDays = (() => {
        if (!selectedTripObj?.start_date || !selectedTripObj?.end_date) return null;
        const s = new Date(selectedTripObj.start_date);
        const e = new Date(selectedTripObj.end_date);
        return Math.ceil((e - s) / 86400000);
    })();

    return (
        <div>
            {confirm && (
                <ConfirmDialog
                    title={confirm.type === 'trip' ? 'Ta bort resa?' : confirm.type === 'complete' ? 'Avsluta resa?' : confirm.type === 'unplan' ? 'Flytta till Planerade resor?' : 'Ta bort utgift?'}
                    message={confirm.type === 'trip'
                        ? `"${confirm.name}" och alla dess utgifter raderas permanent. Det gÃ¥r inte att Ã¥ngra.`
                        : confirm.type === 'complete'
                        ? `"${confirm.name}" markeras som avslutad och flyttas till Avslutade Resor. Du kan fortfarande se den dÃ¤r.`
                        : confirm.type === 'unplan'
                        ? `"${confirm.name}" flyttas tillbaka till Planerade Resor. Utgifterna sparas kvar.`
                        : `"${confirm.name}" raderas permanent.`}
                    confirmLabel={confirm.type === 'complete' ? 'Avsluta resa' : confirm.type === 'unplan' ? 'Flytta tillbaka' : 'Ta bort'}
                    onConfirm={() => {
                        if (confirm.type === 'trip') onDeleteTrip(confirm.id);
                        else if (confirm.type === 'complete') onCompleteTrip(confirm.id);
                        else if (confirm.type === 'unplan') onUnplanTrip(confirm.id);
                        else onDeleteExpense(confirm.id);
                        setConfirm(null);
                    }}
                    onCancel={() => setConfirm(null)}
                />
            )}

            {/* EXPORT MODAL */}
            {exportData && (
                <TripExportModal
                    trip={exportData.trip}
                    expenses={exportData.expenses}
                    categories={exportData.categories}
                    users={exportData.users}
                    onClose={() => setExportData(null)}
                />
            )}

            {/* REDIGERA UTGIFT MODAL */}
            {editingExpense && (
                <div className="modal-overlay" onClick={() => setEditingExpense(null)}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth:'480px'}}>
                        <div className="modal-header">
                            <span className="modal-title">âœï¸ Redigera utgift</span>
                            <button className="close-btn" onClick={() => setEditingExpense(null)}>Ã—</button>
                        </div>
                        <div style={{display:'flex', flexDirection:'column', gap:'0.75rem'}}>
                            <div className="form-group" style={{marginBottom:0}}>
                                <label className="form-label">Beskrivning</label>
                                <input className="form-input" value={editingExpense.description}
                                    onChange={e => setEditingExpense({...editingExpense, description: e.target.value})} />
                            </div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.75rem'}}>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label className="form-label">Belopp</label>
                                    <input type="number" step="0.01" className="form-input" value={editingExpense.amount}
                                        onChange={e => setEditingExpense({...editingExpense, amount: e.target.value})} />
                                </div>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label className="form-label">Valuta</label>
                                    <select className="form-select" value={editingExpense.currency}
                                        onChange={e => setEditingExpense({...editingExpense, currency: e.target.value})}>
                                        {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.75rem'}}>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label className="form-label">Kategori</label>
                                    <select className="form-select" value={editingExpense.category}
                                        onChange={e => setEditingExpense({...editingExpense, category: e.target.value})}>
                                        {categories.map(c => <option key={c.id} value={c.id}>{c.icon} {c.name}</option>)}
                                    </select>
                                </div>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label className="form-label">Datum</label>
                                    <input type="date" className="form-input" value={editingExpense.date ? editingExpense.date.split('T')[0] : ''}
                                        onChange={e => setEditingExpense({...editingExpense, date: e.target.value})} />
                                </div>
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <label className="form-label">Anteckning</label>
                                <textarea className="form-input" rows="3" placeholder="Valfri anteckning..."
                                    style={{resize:'vertical', fontFamily:'inherit'}}
                                    value={editingExpense.note || ''}
                                    onChange={e => setEditingExpense({...editingExpense, note: e.target.value})} />
                            </div>
                            <div style={{display:'flex', gap:'0.75rem', marginTop:'0.25rem'}}>
                                <button className="btn btn-secondary" style={{flex:1}} onClick={() => setEditingExpense(null)}>Avbryt</button>
                                <button className="btn btn-primary" style={{flex:1}} onClick={handleSaveEdit}>ğŸ’¾ Spara</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* RESAKORT */}
            <TripCards
                trips={trips}
                selectedTrip={selectedTrip}
                onSelectTrip={onSelectTrip}
                allExpenses={allExpenses}
                onAddTrip={onAddTrip}
                onDeleteTrip={handleDeleteTripConfirm}
                onCompleteTrip={(id, name) => setConfirm({ type:'complete', id, name })}
                onUnplanTrip={(id, name) => setConfirm({ type:'unplan', id, name })}
                onNewPlannedTrip={onNewPlannedTrip}
                onUpdateTrip={onUpdateTrip}
            />

            {!selectedTrip ? (
                <div className="card" style={{textAlign:'center', padding:'3rem'}}>
                    <p style={{color:'var(--text-muted)'}}>VÃ¤lj en resa ovan fÃ¶r att se och lÃ¤gga till utgifter</p>
                </div>
            ) : (
                <>
                    {/* KATEGORIER */}
                    <div style={{marginBottom:'0.5rem'}}>
                        <button
                            className="btn btn-secondary btn-small"
                            style={{marginBottom:'0.75rem'}}
                            onClick={() => setShowCatManager(!showCatManager)}
                        >
                            {showCatManager ? 'â–² DÃ¶lj kategorier' : 'âš™ Hantera kategorier'}
                        </button>
                        {showCatManager && (
                            <CategoryManager
                                categories={categories}
                                onAdd={onAddCategory}
                                onDelete={onDeleteCategory}
                            />
                        )}
                    </div>

                    {/* LÃ„GG TILL UTGIFT */}
                    <form onSubmit={handleAddExpense} className="quick-add-form">
                        <h3 style={{marginBottom:'1rem', fontSize:'1.25rem'}}>âš¡ LÃ¤gg till utgift</h3>
                        <div className="quick-add-grid">
                            <div className="form-group" style={{marginBottom:0}}>
                                <input type="text" className="form-input" placeholder="Vad kÃ¶pte du?" value={description} onChange={e => setDescription(e.target.value)} required disabled={submitting} />
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <input type="number" step="0.01" className="form-input" placeholder="Belopp" value={amount} onChange={e => setAmount(e.target.value)} required disabled={submitting} />
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <select className="form-select" value={currency} onChange={e => setCurrency(e.target.value)} disabled={submitting}>
                                    {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code} {c.rate !== FALLBACK_RATES[c.code] ? 'â—' : ''}</option>)}
                                </select>
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <select className="form-select" value={category} onChange={e => setCategory(e.target.value)} disabled={submitting}>
                                    {categories.map(c => <option key={c.id} value={c.id}>{c.icon} {c.name}</option>)}
                                </select>
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <input type="date" className="form-input" value={expenseDate} onChange={e => setExpenseDate(e.target.value)} disabled={submitting} required />
                            </div>
                            <div className="form-group" style={{marginBottom:0, gridColumn:'1/-1'}}>
                                <input type="text" className="form-input" placeholder="Anteckning (valfritt)..." value={note} onChange={e => setNote(e.target.value)} disabled={submitting} />
                            </div>
                            <button type="submit" className="btn btn-secondary" style={{gridColumn:'1/-1'}} disabled={submitting || !selectedTrip}>
                                {submitting ? '...' : 'LÃ¤gg till'}
                            </button>
                        </div>
                        {ratesUpdated && (
                            <div style={{fontSize:'0.72rem', color:'var(--text-muted)', marginTop:'0.5rem'}}>
                                ğŸ“¡ Valutakurser uppdaterade {ratesUpdated}
                            </div>
                        )}
                    </form>

                    {/* STATISTIK */}
                    <div className="grid" style={{gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))'}}>
                        <div className="card stat-card">
                            <div className="stat-value">{totalSEK.toFixed(0)} kr</div>
                            <div className="stat-label">Total</div>
                        </div>
                        <div className="card stat-card">
                            <div className="stat-value">{expenses.length}</div>
                            <div className="stat-label">Utgifter</div>
                        </div>
                        {daysRemaining !== null && (
                            <div className="card stat-card">
                                <div className="stat-value" style={{color: daysRemaining < 0 ? 'var(--danger)' : daysRemaining <= 2 ? '#f57f17' : 'var(--primary)'}}>
                                    {daysRemaining < 0 ? 0 : daysRemaining}
                                </div>
                                <div className="stat-label">
                                    {daysRemaining < 0 ? 'Resan avslutad' : 'Dagar kvar'}
                                </div>
                                {daysRemaining >= 0 && totalDays > 0 && expenses.length > 0 && (
                                    <div style={{fontSize:'0.8rem', color:'var(--text-muted)', marginTop:'0.3rem'}}>
                                        {(totalSEK / Math.max(1, totalDays - daysRemaining)).toFixed(0)} kr/dag hittills
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* PER KATEGORI */}
                    {categoryTotals.length > 0 && (
                        <div className="card" style={{marginBottom:'2rem'}}>
                            <h3 className="card-title" style={{marginBottom:'1rem'}}>Per Kategori</h3>
                            <div className="expense-list">
                                {categoryTotals.map(cat => (
                                    <div key={cat.id} style={{display:'flex', justifyContent:'space-between', padding:'0.75rem', background:'var(--bg)', borderRadius:'6px'}}>
                                        <span>{cat.icon} {cat.name}</span>
                                        <span style={{fontFamily:'Space Mono', fontWeight:700}}>{cat.total.toFixed(0)} kr</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* UTGIFTSLISTA MED DAGÃ–VERSIKT */}
                    <div className="card">
                        <div className="card-header">
                            <h3 className="card-title">Alla utgifter</h3>
                            <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                {expenses.length > 0 && selectedTripObj && (
                                    <button className="btn btn-secondary btn-small" style={{fontSize:'0.8rem'}} onClick={() => setExportData({ trip: selectedTripObj, expenses, categories, users })}>ğŸ“¤ Exportera</button>
                                )}
                                {expenses.length > 0 && (
                                    <div className="view-toggle">
                                        <span className="view-toggle-label">Visa:</span>
                                        <button className={`toggle-btn ${expenseView==='list'?'active':''}`} onClick={() => setExpenseView('list')}>Lista</button>
                                        <button className={`toggle-btn ${expenseView==='day'?'active':''}`} onClick={() => setExpenseView('day')}>Per dag</button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {expenses.length === 0 ? (
                            <p style={{textAlign:'center', color:'var(--text-muted)', padding:'2rem'}}>Inga utgifter Ã¤nnu</p>
                        ) : expenseView === 'list' ? (
                            <div className="expense-list">
                                {expenses.map(expense => {
                                    const cat = getCatInfo(expense.category);
                                    return (
                                        <div key={expense.id} className="expense-item" style={{flexWrap:'wrap'}}>
                                            <div className="expense-category">{cat.icon}</div>
                                            <div className="expense-details" style={{flex:1, minWidth:0}}>
                                                <div className="expense-description">{expense.description}</div>
                                                <div className="expense-meta">
                                                    {cat.name} Â· {getUserName(expense.added_by)} Â· {new Date(expense.date).toLocaleDateString('sv-SE')}
                                                </div>
                                                {expense.note && (
                                                    <div style={{fontSize:'0.78rem', color:'var(--text-muted)', marginTop:'0.2rem', fontStyle:'italic'}}>
                                                        ğŸ“ {expense.note}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="expense-amount">
                                                <div className="expense-price">{(expense.amount * expense.exchange_rate).toFixed(0)} kr</div>
                                                <div className="expense-currency">({expense.amount.toFixed(0)} {expense.currency})</div>
                                            </div>
                                            <div style={{display:'flex', gap:'0.3rem'}}>
                                                <button
                                                    className="btn btn-secondary btn-icon btn-small"
                                                    title="Redigera utgift"
                                                    onClick={() => setEditingExpense({...expense, date: expense.date.split('T')[0]})}
                                                >âœï¸</button>
                                                <button
                                                    className="btn btn-danger btn-icon btn-small"
                                                    title="Ta bort utgift"
                                                    onClick={() => setConfirm({ type:'expense', id:expense.id, name:expense.description })}
                                                >ğŸ—‘</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <DayBreakdown expenses={expenses} categories={categories} users={users} />
                        )}
                    </div>
                </>
            )}
        </div>
    );
}

// â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AdminView({ users, onAddUser, onDeleteUser, onResetPassword, onToggleAdmin }) {
    const [showAddUser, setShowAddUser] = useState(false);
    const [newUser, setNewUser] = useState({ username:'', password:'', name:'', is_admin:false });
    const [submitting, setSubmitting] = useState(false);
    const [visiblePasswords, setVisiblePasswords] = useState({});

    const togglePassword = (id) => setVisiblePasswords(prev => ({ ...prev, [id]: !prev[id] }));

    const handleAddUser = async (e) => {
        e.preventDefault();
        setSubmitting(true);
        await onAddUser(newUser);
        setNewUser({ username:'', password:'', name:'', is_admin:false });
        setShowAddUser(false);
        setSubmitting(false);
    };

    return (
        <div>
            <div style={{marginBottom:'1.5rem'}}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                    <h3 style={{fontSize:'1.1rem', fontWeight:700, color:'var(--text)'}}>AnvÃ¤ndare</h3>
                    <button className="btn btn-primary btn-small" onClick={() => setShowAddUser(!showAddUser)}>+ LÃ¤gg till anvÃ¤ndare</button>
                </div>

                {showAddUser && (
                    <form onSubmit={handleAddUser} style={{marginBottom:'1.5rem', padding:'1rem', background:'var(--bg)', borderRadius:'8px'}}>
                        {[['Namn','name','text'],['AnvÃ¤ndarnamn','username','text'],['LÃ¶senord','password','password']].map(([label, key, type]) => (
                            <div className="form-group" key={key}>
                                <label className="form-label">{label}</label>
                                <input type={type} className="form-input" value={newUser[key]} onChange={e => setNewUser({...newUser, [key]: e.target.value})} required disabled={submitting} />
                            </div>
                        ))}
                        <div className="form-group">
                            <label style={{display:'flex', alignItems:'center', gap:'0.5rem', cursor:'pointer'}}>
                                <input type="checkbox" checked={newUser.is_admin} onChange={e => setNewUser({...newUser, is_admin: e.target.checked})} disabled={submitting} />
                                Admin-rÃ¤ttigheter
                            </label>
                        </div>
                        <button type="submit" className="btn btn-primary" disabled={submitting}>
                            {submitting ? 'Skapar...' : 'Skapa anvÃ¤ndare'}
                        </button>
                    </form>
                )}

                <div className="user-list">
                    {users.map(user => (
                        <div key={user.id} className="user-item">
                            <div className="user-item-info">
                                <div className="user-avatar">{user.name.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style={{fontWeight:500}}>{user.name}</div>
                                    <div style={{fontSize:'0.875rem', color:'var(--text-muted)'}}>@{user.username}{user.is_admin && ' Â· Admin'}</div>
                                    <div style={{display:'flex', alignItems:'center', gap:'0.4rem', marginTop:'0.2rem'}}>
                                        <span style={{
                                            fontSize:'0.82rem', fontFamily:'Space Mono, monospace',
                                            color: visiblePasswords[user.id] ? 'var(--text)' : 'var(--text-muted)',
                                            letterSpacing: visiblePasswords[user.id] ? 'normal' : '0.15em'
                                        }}>
                                            {visiblePasswords[user.id] ? user.password : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}
                                        </span>
                                        <button
                                            onClick={() => togglePassword(user.id)}
                                            style={{
                                                background:'none', border:'none', cursor:'pointer',
                                                fontSize:'0.85rem', padding:'0.1rem 0.3rem',
                                                color:'var(--text-muted)', borderRadius:'4px',
                                                lineHeight:1, transition:'color 0.15s'
                                            }}
                                            title={visiblePasswords[user.id] ? 'DÃ¶lj lÃ¶senord' : 'Visa lÃ¶senord'}
                                        >{visiblePasswords[user.id] ? 'ğŸ™ˆ' : 'ğŸ‘'}</button>
                                    </div>
                                </div>
                            </div>
                            <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap'}}>
                                <button className="btn btn-secondary btn-small" onClick={() => { const p = prompt('Nytt lÃ¶senord fÃ¶r ' + user.name); if (p) onResetPassword(user.id, p); }}>Ã…terstÃ¤ll lÃ¶senord</button>
                                <button className={`btn btn-small ${user.is_admin ? 'btn-secondary' : 'btn-primary'}`} onClick={() => { if (confirm(`${user.is_admin ? 'Ta bort' : 'Ge'} admin fÃ¶r ${user.name}?`)) onToggleAdmin(user.id, !user.is_admin); }}>
                                    {user.is_admin ? 'â¬‡ï¸ Ta bort admin' : 'â¬†ï¸ GÃ¶r till admin'}
                                </button>
                                <button className="btn btn-danger btn-small" onClick={() => { if (confirm('Ta bort ' + user.name + '? Det gÃ¥r inte att Ã¥ngra.')) onDeleteUser(user.id); }}>Ta bort</button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
